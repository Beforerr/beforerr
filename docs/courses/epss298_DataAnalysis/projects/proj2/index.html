<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.9.12">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Project 2 – beforerr</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../../">
<link href="../../../../../docs/courses/epss298_DataAnalysis/projects/proj2/CNN_script_EPS_SCI_298_example.html" rel="next">
<link href="../../../../../docs/courses/epss298_DataAnalysis/projects/proj1.html" rel="prev">
<script src="../../../../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../../../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../../../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../../site_libs/quarto-html/quarto-syntax-highlighting-cdaacfc258cb6f151192107f105ac881.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../../site_libs/bootstrap/bootstrap-5b4ad623e5705c0698d39aec6f10cf02.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../../../index.html">
    <span class="navbar-title">beforerr</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../docs/research/index.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../../docs/projects/index.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-others" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Others</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-others">    
        <li>
    <a class="dropdown-item" href="../../../../../docs/blog/index.html">
 <span class="dropdown-text">Blog</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../../docs/others/phd/index.html">
 <span class="dropdown-text">PhD</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../../../docs/courses/index.html">
 <span class="dropdown-text">Courses</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/Beforerr/beforerr" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../../../docs/courses/index.html">Courses</a></li><li class="breadcrumb-item"><a href="../../../../../docs/courses/epss298_DataAnalysis/index.html">EPSS 298</a></li><li class="breadcrumb-item"><a href="../../../../../docs/courses/epss298_DataAnalysis/projects/proj1.html">Projects</a></li><li class="breadcrumb-item"><a href="../../../../../docs/courses/epss298_DataAnalysis/projects/proj2/index.html">Project 2</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../../../../docs/courses/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Courses</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../../../../docs/courses/epss261/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">EPSS 261</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../../../../docs/courses/epss261/homework/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">EPSS 261 Homework</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/epss261/homework/ps1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem Set 1</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/epss261/homework/ps2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem Set 2</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/epss261/homework/ps3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem Set 3</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/epss261/homework/ps4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem Set 4</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/epss261/homework/ps5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem Set 5</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/epss261/homework/ps6.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem Set 6</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../../../../docs/courses/astr145/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ASTR 145</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false">
 <span class="menu-text">Homework</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/astr145/homework/ps1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem Set 1</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/astr145/homework/ps2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem Set 2</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/astr145/homework/ps3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem Set 3</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/astr145/homework/ps4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem Set 4</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/astr145/homework/ps5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem Set 5</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/astr145/homework/ps6.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem Set 6</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/astr145/homework/ps7.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem Set 7</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/astr145/homework/ps8.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem Set 8</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../../../../docs/courses/epss298_DataAnalysis/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">EPSS 298</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="false">
 <span class="menu-text">Homework</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/epss298_DataAnalysis/homework/ps1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Problem Set 1</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="false">
 <span class="menu-text">Lectures</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/epss298_DataAnalysis/lectures/gp_exercise.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to Gaussian processes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/epss298_DataAnalysis/lectures/mcmc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture lab</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="true">
 <span class="menu-text">Projects</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth3 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/epss298_DataAnalysis/projects/proj1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Project 1</span></a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../../../../docs/courses/epss298_DataAnalysis/projects/proj2/index.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Project 2</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-10" class="collapse list-unstyled sidebar-section depth4 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/epss298_DataAnalysis/projects/proj2/CNN_script_EPS_SCI_298_example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">EPS-SCI-298 – Convolutive Neural Networks</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../../../../docs/courses/epss263/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">EPSS M263</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-11" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../../../../docs/courses/epss263/homework/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-12" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-12" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/epss263/homework/epss263_hw02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework 02</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/epss263/homework/epss263_hw03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework 03</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/epss263/homework/epss263_hw04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework 04</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/epss263/homework/epss263_hw05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework 05</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/epss263/homework/epss263_hw06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework 06</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../../../../docs/courses/epss298_MHD_turbulence/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">EPSS 298</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-13" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-13" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/epss298_MHD_turbulence/pre.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Role of Magnetic Reconnection (Tearing Instability) in Magnetohydrodynamic Turbulence</span></a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-14" role="navigation" aria-expanded="false">
 <span class="menu-text">Homework</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-14" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-14" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/epss298_MHD_turbulence/homework/ps1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Selective decay of magnetic helicity</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../../../../docs/courses/phys231/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">PHYSICS 231A</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-15" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-15" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/phys231/phys231_hw02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework 02</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/phys231/phys231_hw03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework 03</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/phys231/phys231_hw04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework 04</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/phys231/phys231_hw05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework 05</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/phys231/phys231_hw06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework 06</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/phys231/phys231_hw07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework 07</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/phys231/phys231_hw08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework 08</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/phys231/phys231_hw09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework 09</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../../../../docs/courses/epss265/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">EPSS 265</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-16" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-16" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../../../../docs/courses/epss265/homeworks/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-17" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-17" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/epss265/homeworks/epss265_hw02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">02 - FGM Basics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/epss265/homeworks/epss265_hw03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">03 - SCM Noise Curves</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/epss265/homeworks/epss265_hw04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">04 - EFI Calibration</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/epss265/homeworks/epss265_hw05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">05 - LEP Principles</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/epss265/homeworks/epss265_hw06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">06 - FPI</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-18" role="navigation" aria-expanded="false">
 <span class="menu-text">Project</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-18" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-18" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../../docs/courses/epss265/project/project.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Poor man’s magnetometer</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#step-1-data-exploration" id="toc-step-1-data-exploration" class="nav-link active" data-scroll-target="#step-1-data-exploration">Step 1: Data exploration</a></li>
  <li><a href="#step-2-prepare-the-images" id="toc-step-2-prepare-the-images" class="nav-link" data-scroll-target="#step-2-prepare-the-images">Step 2: Prepare the images</a>
  <ul class="collapse">
  <li><a href="#crop-resize-and-save-images" id="toc-crop-resize-and-save-images" class="nav-link" data-scroll-target="#crop-resize-and-save-images">Crop, resize, and save images</a></li>
  <li><a href="#data-split-dataset-and-dataloader" id="toc-data-split-dataset-and-dataloader" class="nav-link" data-scroll-target="#data-split-dataset-and-dataloader">Data split, Dataset, and DataLoader</a></li>
  </ul></li>
  <li><a href="#step-3-defining-a-cnn" id="toc-step-3-defining-a-cnn" class="nav-link" data-scroll-target="#step-3-defining-a-cnn">Step 3: Defining a CNN</a></li>
  <li><a href="#step-4-training-the-network" id="toc-step-4-training-the-network" class="nav-link" data-scroll-target="#step-4-training-the-network">Step 4: Training the network</a></li>
  <li><a href="#step-5-model-evaluation" id="toc-step-5-model-evaluation" class="nav-link" data-scroll-target="#step-5-model-evaluation">Step 5: Model evaluation</a></li>
  <li><a href="#step-6-model-modification" id="toc-step-6-model-modification" class="nav-link" data-scroll-target="#step-6-model-modification">Step 6: Model modification</a>
  <ul class="collapse">
  <li><a href="#using-resnet-for-galaxy-classification" id="toc-using-resnet-for-galaxy-classification" class="nav-link" data-scroll-target="#using-resnet-for-galaxy-classification">Using ResNet for Galaxy Classification</a></li>
  <li><a href="#testing-the-resnet-model-with-sample-data" id="toc-testing-the-resnet-model-with-sample-data" class="nav-link" data-scroll-target="#testing-the-resnet-model-with-sample-data">Testing the ResNet Model with Sample Data</a></li>
  <li><a href="#training-the-resnet-model" id="toc-training-the-resnet-model" class="nav-link" data-scroll-target="#training-the-resnet-model">Training the ResNet Model</a></li>
  <li><a href="#visualizing-resnet-training-results" id="toc-visualizing-resnet-training-results" class="nav-link" data-scroll-target="#visualizing-resnet-training-results">Visualizing ResNet Training Results</a></li>
  <li><a href="#comparing-resnet-with-original-cnn" id="toc-comparing-resnet-with-original-cnn" class="nav-link" data-scroll-target="#comparing-resnet-with-original-cnn">Comparing ResNet with Original CNN</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/Beforerr/beforerr/blob/main/docs/courses/epss298_DataAnalysis/projects/proj2/index.qmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li><li><a href="https://github.com/Beforerr/beforerr/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div><div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="index.pdf"><i class="bi bi-file-pdf"></i>Typst</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../../../docs/courses/index.html">Courses</a></li><li class="breadcrumb-item"><a href="../../../../../docs/courses/epss298_DataAnalysis/index.html">EPSS 298</a></li><li class="breadcrumb-item"><a href="../../../../../docs/courses/epss298_DataAnalysis/projects/proj1.html">Projects</a></li><li class="breadcrumb-item"><a href="../../../../../docs/courses/epss298_DataAnalysis/projects/proj2/index.html">Project 2</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Project 2</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Artificial Neural Networks and Deep Learning</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Images of galaxies obtained by the Sloan Digital Sky Survey (SDSS) have been classified by different people through a participatory science process (see this article: https://arxiv.org/abs/1308.3496). There are tens of thousands of classified examples. However, there are even more images, and classifying them all by humans would take an enormous amount of time.</p>
<p>Our goal is therefore to develop a method to classify these images efficiently. We will use a convolutional neural network.</p>
<p>There are 37 non-exclusive categories (a galaxy can belong to more than one group). Since classification is sometimes ambiguous, participants did not always get the same answers. For each galaxy, the classification result is therefore a probability of belonging to one of the categories. To train the network, we will therefore use the mean squared error (MSE) to compare the probabilities given by the network.</p>
<p><span class="math display">\[
MSE = \frac{1}{N} \sum_{n} (x_n - y_n)^2  
\]</span></p>
<p>For our final criterion (i.e., the one we will give as the answer at the very end), we will use the root of the MSE (RMSE): <span class="math inline">\(RMSE = \sqrt{MSE}\)</span>. This is therefore a regression problem (37 output values y that we are trying to predict with the model), although the ultimate goal is to classify galaxies.</p>
<section id="step-1-data-exploration" class="level2">
<h2 class="anchored" data-anchor-id="step-1-data-exploration">Step 1: Data exploration</h2>
<p>The images are in a folder called images_training_rev1. The probabilities for each class are in the file <code>training_solutions_rev1.csv</code>. GalaxyID gives the identifier and each file in the folder corresponds to a GalaxyID (with a .jpg extension). To familiarize yourself with the data:</p>
<ol type="1">
<li><p>(Optional, not to be displayed in the submission) Import the CSV file and display the first few rows</p></li>
<li><p>Display the galaxy with the highest probability for each class (a .jpg or .png image). The format is: (dim1, dim2, C) where C=3 in our case. (Please include these images in a single figure, displaying the category name above each image).</p></li>
</ol>
<p>Display the resulting figure with a brief explanation. Submit the code used to import the CSV and generate the figure.</p>
<div id="2" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>dir <span class="op">=</span> <span class="st">"docs/courses/epss298_DataAnalysis/projects/proj2"</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="fu">isdir</span>(dir)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cd</span>(dir)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Pkg</span>.<span class="fu">activate</span>(<span class="st">"."</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Pkg</span>.<span class="fu">resolve</span>()</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Pkg</span>.<span class="fu">instantiate</span>()</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="4" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">CSV</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">DataFrames</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>galaxy_data <span class="op">=</span> CSV.<span class="fu">read</span>(<span class="st">"data/training_solutions_rev1.csv"</span>, DataFrame)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(galaxy_data, <span class="fu">names</span>(galaxy_data, <span class="dt">Float64</span>) <span class="op">.=&gt;</span> x <span class="op">-&gt;</span> <span class="fu">Float32</span>.(x); renamecols<span class="op">=</span><span class="cn">false</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>class_columns <span class="op">=</span> <span class="fu">names</span>(galaxy_data)[<span class="fl">2</span><span class="op">:</span><span class="kw">end</span>]</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>DESCRIPTIONS <span class="op">=</span> [</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Smooth"</span>, <span class="st">"Featured or disc"</span>, <span class="st">"Star or artifact"</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Edge on"</span>, <span class="st">"Not edge on"</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Bar through center"</span>, <span class="st">"No bar"</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Spiral"</span>, <span class="st">"No Spiral"</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"No bulge"</span>, <span class="st">"Just noticeable bulge"</span>, <span class="st">"Obvious bulge"</span>, <span class="st">"Dominant bulge"</span>,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Odd Feature"</span>, <span class="st">"No Odd Feature"</span>,</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Completely round"</span>, <span class="st">"In between"</span>, <span class="st">"Cigar shaped"</span>,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Ring"</span>, <span class="st">"Lens or arc"</span>, <span class="st">"Disturbed"</span>, <span class="st">"Irregular"</span>, <span class="st">"Other"</span>, <span class="st">"Merger"</span>, <span class="st">"Dust lane"</span>,</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Rounded bulge"</span>, <span class="st">"Boxy bulge"</span>, <span class="st">"No bulge"</span>,</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Tightly wound arms"</span>, <span class="st">"Medium wound arms"</span>, <span class="st">"Loose wound arms"</span>,</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"1 Spiral Arm"</span>, <span class="st">"2 Spiral Arms"</span>, <span class="st">"3 Spiral Arms"</span>, <span class="st">"4 Spiral Arms"</span>,</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"More than four Spiral Arms"</span>, <span class="st">"Can't tell how many spiral arms"</span>,</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> CDICT <span class="op">=</span> <span class="fu">Dict</span>(class_columns <span class="op">.=&gt;</span> DESCRIPTIONS)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>Dict{String, String} with 37 entries:
  "Class5.1"  =&gt; "No bulge"
  "Class8.5"  =&gt; "Other"
  "Class7.2"  =&gt; "In between"
  "Class11.2" =&gt; "2 Spiral Arms"
  "Class11.3" =&gt; "3 Spiral Arms"
  "Class3.1"  =&gt; "Bar through center"
  "Class8.2"  =&gt; "Lens or arc"
  "Class7.1"  =&gt; "Completely round"
  "Class6.2"  =&gt; "No Odd Feature"
  "Class6.1"  =&gt; "Odd Feature"
  "Class2.1"  =&gt; "Edge on"
  "Class1.2"  =&gt; "Featured or disc"
  "Class1.1"  =&gt; "Smooth"
  "Class1.3"  =&gt; "Star or artifact"
  "Class2.2"  =&gt; "Not edge on"
  "Class5.4"  =&gt; "Dominant bulge"
  "Class10.1" =&gt; "Tightly wound arms"
  "Class4.1"  =&gt; "Spiral"
  "Class8.1"  =&gt; "Ring"
  ⋮           =&gt; ⋮</code></pre>
</div>
</div>
<div id="6" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">FileIO</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Images</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">load_img</span>(id) <span class="op">=</span> Images.<span class="fu">load</span>(<span class="fu">File</span><span class="dt">{format"JPEG"}</span>(<span class="st">"data/images_training_rev1/</span><span class="sc">$</span>(id)<span class="st">.jpg"</span>))</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">load_processed_img</span>(id) <span class="op">=</span> Images.<span class="fu">load</span>(<span class="fu">File</span><span class="dt">{format"JPEG"}</span>(<span class="st">"data/processed_images/</span><span class="sc">$</span>(id)<span class="st">.jpg"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>load_processed_img (generic function with 1 method)</code></pre>
</div>
</div>
<div id="8" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the galaxy with highest probability for each class</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>highest_prob_df <span class="op">=</span> <span class="fu">DataFrame</span>(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(class_columns) <span class="cf">do</span> Class</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        max_idx <span class="op">=</span> <span class="fu">argmax</span>(galaxy_data[!, Class])</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        GalaxyID <span class="op">=</span> galaxy_data[max_idx, <span class="op">:</span>GalaxyID]</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        Probability <span class="op">=</span> galaxy_data[max_idx, Class]</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        (; Class, GalaxyID, Probability)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<div><div style="float: left;"><span>37×3 DataFrame</span></div><div style="float: right;"><span style="font-style: italic;">12 rows omitted</span></div><div style="clear: both;"></div></div><div class="data-frame" style="overflow-x: scroll;">
<table class="data-frame caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;">Row</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Class</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">GalaxyID</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Probability</th>
</tr>
<tr class="subheader headerLastRow even">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Int64">Int64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float32">Float32</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1</td>
<td style="text-align: left;">Class1.1</td>
<td style="text-align: right;">105447</td>
<td style="text-align: right;">1.0</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">2</td>
<td style="text-align: left;">Class1.2</td>
<td style="text-align: right;">100859</td>
<td style="text-align: right;">1.0</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">3</td>
<td style="text-align: left;">Class1.3</td>
<td style="text-align: right;">356310</td>
<td style="text-align: right;">0.935147</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">4</td>
<td style="text-align: left;">Class2.1</td>
<td style="text-align: right;">344604</td>
<td style="text-align: right;">1.0</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">5</td>
<td style="text-align: left;">Class2.2</td>
<td style="text-align: right;">105009</td>
<td style="text-align: right;">1.0</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">6</td>
<td style="text-align: left;">Class3.1</td>
<td style="text-align: right;">205541</td>
<td style="text-align: right;">1.0</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">7</td>
<td style="text-align: left;">Class3.2</td>
<td style="text-align: right;">185561</td>
<td style="text-align: right;">1.0</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">8</td>
<td style="text-align: left;">Class4.1</td>
<td style="text-align: right;">105009</td>
<td style="text-align: right;">1.0</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">9</td>
<td style="text-align: left;">Class4.2</td>
<td style="text-align: right;">780966</td>
<td style="text-align: right;">0.957937</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">10</td>
<td style="text-align: left;">Class5.1</td>
<td style="text-align: right;">454627</td>
<td style="text-align: right;">0.803556</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">11</td>
<td style="text-align: left;">Class5.2</td>
<td style="text-align: right;">706376</td>
<td style="text-align: right;">0.965112</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">12</td>
<td style="text-align: left;">Class5.3</td>
<td style="text-align: right;">180894</td>
<td style="text-align: right;">0.891034</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">13</td>
<td style="text-align: left;">Class5.4</td>
<td style="text-align: right;">877297</td>
<td style="text-align: right;">0.650383</td>
</tr>
<tr class="even">
<td style="text-align: right;">⋮</td>
<td style="text-align: right;">⋮</td>
<td style="text-align: right;">⋮</td>
<td style="text-align: right;">⋮</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">26</td>
<td style="text-align: left;">Class9.1</td>
<td style="text-align: right;">827293</td>
<td style="text-align: right;">0.985982</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">27</td>
<td style="text-align: left;">Class9.2</td>
<td style="text-align: right;">162557</td>
<td style="text-align: right;">0.889493</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">28</td>
<td style="text-align: left;">Class9.3</td>
<td style="text-align: right;">107454</td>
<td style="text-align: right;">0.901991</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">29</td>
<td style="text-align: left;">Class10.1</td>
<td style="text-align: right;">309198</td>
<td style="text-align: right;">0.949733</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">30</td>
<td style="text-align: left;">Class10.2</td>
<td style="text-align: right;">121394</td>
<td style="text-align: right;">0.877393</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">31</td>
<td style="text-align: left;">Class10.3</td>
<td style="text-align: right;">416488</td>
<td style="text-align: right;">0.996952</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">32</td>
<td style="text-align: left;">Class11.1</td>
<td style="text-align: right;">848818</td>
<td style="text-align: right;">0.886363</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">33</td>
<td style="text-align: left;">Class11.2</td>
<td style="text-align: right;">105009</td>
<td style="text-align: right;">1.0</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">34</td>
<td style="text-align: left;">Class11.3</td>
<td style="text-align: right;">121006</td>
<td style="text-align: right;">0.975913</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">35</td>
<td style="text-align: left;">Class11.4</td>
<td style="text-align: right;">233081</td>
<td style="text-align: right;">0.957</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">36</td>
<td style="text-align: left;">Class11.5</td>
<td style="text-align: right;">495381</td>
<td style="text-align: right;">0.938881</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">37</td>
<td style="text-align: left;">Class11.6</td>
<td style="text-align: right;">598442</td>
<td style="text-align: right;">0.753082</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="10" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">CairoMakie</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">CairoMakie</span>: Axis</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>num_classes <span class="op">=</span> <span class="fu">nrow</span>(highest_prob_df)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">plot_images</span>(df, load; width<span class="op">=</span><span class="fl">150</span>, height<span class="op">=</span><span class="fl">150</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">Figure</span>()</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate grid dimensions - aim for roughly square layout</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    ncols <span class="op">=</span> <span class="fu">ceil</span>(<span class="dt">Int</span>, <span class="fu">sqrt</span>(num_classes))</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    nrows <span class="op">=</span> <span class="fu">ceil</span>(<span class="dt">Int</span>, num_classes <span class="op">/</span> ncols)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load and display each image</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i, row) <span class="kw">in</span> <span class="fu">enumerate</span>(<span class="fu">eachrow</span>(highest_prob_df))</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        row_idx <span class="op">=</span> <span class="fu">div</span>(i <span class="op">-</span> <span class="fl">1</span>, ncols) <span class="op">+</span> <span class="fl">1</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        col_idx <span class="op">=</span> <span class="fu">mod</span>(i <span class="op">-</span> <span class="fl">1</span>, ncols) <span class="op">+</span> <span class="fl">1</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> <span class="st">"</span><span class="sc">$</span>(row.Class)<span class="sc">\n$</span>(CDICT[row.Class])<span class="sc">\n</span><span class="st">Prob: </span><span class="sc">$</span>(<span class="fu">round</span>(row.Probability, digits<span class="op">=</span><span class="fl">2</span>))<span class="st">"</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        ax <span class="op">=</span> <span class="fu">Axis</span>(fig[row_idx, col_idx]; width, height, title,)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">hidedecorations!</span>(ax)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">image!</span>(ax, <span class="fu">load</span>(row.GalaxyID))</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">resize_to_layout!</span>(fig)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_images</span>(highest_prob_df, load_img)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-6-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="step-2-prepare-the-images" class="level2">
<h2 class="anchored" data-anchor-id="step-2-prepare-the-images">Step 2: Prepare the images</h2>
<blockquote class="blockquote">
<p>The initial format of the images is not optimal. The format is large (424x424) and there is a lot of empty space around the galaxies. Write a code that performs the following tasks:</p>
</blockquote>
<section id="crop-resize-and-save-images" class="level3">
<h3 class="anchored" data-anchor-id="crop-resize-and-save-images">Crop, resize, and save images</h3>
<blockquote class="blockquote">
<ol type="1">
<li>Crop the image to reduce the size by half around the center (212x212)</li>
<li>Reduce the resolution so that the image has 64 pixels on each side<br>
</li>
<li>Save all pre-processed images in a new folder</li>
</ol>
</blockquote>
<div id="12" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">ProgressMeter</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">DataAugmentation</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="pp">@views</span> <span class="kw">function</span> <span class="fu">preprocess_image</span>(img; crop_size<span class="op">=</span><span class="fl">212</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    cropped_img <span class="op">=</span> DataAugmentation.<span class="fu">apply</span>(</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        DataAugmentation.<span class="fu">CenterCrop</span>((crop_size, crop_size)),</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        DataAugmentation.<span class="fu">Image</span>(img)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">|&gt;</span> DataAugmentation.itemdata</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">imresize</span>(cropped_img, (<span class="fl">64</span>, <span class="fl">64</span>))</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">process_and_save_images</span>(galaxy_ids, path)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mkpath</span>(path)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@showprogress</span> <span class="st">"Processing images..."</span> <span class="cf">for</span> id <span class="kw">in</span> galaxy_ids</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        img_path <span class="op">=</span> <span class="fu">joinpath</span>(path, <span class="st">"</span><span class="sc">$</span>(id)<span class="st">.jpg"</span>)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        !<span class="fu">isfile</span>(img_path) <span class="op">&amp;&amp;</span> <span class="fu">save</span>(img_path, <span class="fu">preprocess_image</span>(<span class="fu">load_img</span>(id)))</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Process and save all images</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="fu">process_and_save_images</span>(galaxy_data.GalaxyID, <span class="st">"data/processed_images"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-green-fg">Processing images...  84%|██████████████████████████▏    |  ETA: 0:00:00</span>
<span class="ansi-green-fg">Processing images... 100%|███████████████████████████████| Time: 0:00:00</span>
</pre>
</div>
</div>
</div>
</section>
<section id="data-split-dataset-and-dataloader" class="level3">
<h3 class="anchored" data-anchor-id="data-split-dataset-and-dataloader">Data split, Dataset, and DataLoader</h3>
<ol start="4" type="1">
<li>Using the GalaxyID from the CSV, randomly split the data into two subsets: training and testing. We want 20% of the images to be used exclusively for testing.</li>
<li>Define a Dataset that can import the data and probabilities for each class (one for training, one for testing).</li>
<li>From the two Datasets, create two Dataloaders that use subsets of 64 images.</li>
</ol>
<p>Display the same figure as in Step 1, but with the images modified, explaining how the modifications were made. Submit the code used to modify the images and generate the figure.</p>
<div id="14" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">MLUtils</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="pp">@views</span> <span class="kw">function</span> <span class="fu">get_labels</span>(source, ids)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> <span class="fu">searchsortedfirst</span>.(<span class="fu">Ref</span>(source.GalaxyID), ids)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> source[idx, <span class="fl">2</span><span class="op">:</span><span class="kw">end</span>]</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>get_labels (generic function with 1 method)</code></pre>
</div>
</div>
<div id="16" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Define a Julia Dataset equivalent for training and testing</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> GalaxyDataset{I,L,F}</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    ids<span class="op">::</span><span class="dt">I</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">::</span><span class="dt">L</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    load<span class="op">::</span><span class="dt">F</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="fu">transform_img</span>(img) <span class="op">=</span> <span class="fu">permutedims</span>(<span class="fu">channelview</span>(img), (<span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">1</span>))</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="bu">Base</span>.<span class="fu">getindex</span>(dataset<span class="op">::</span><span class="dt">GalaxyDataset</span>, idx)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    ids <span class="op">=</span> dataset.ids[idx]</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    img_arrays <span class="op">=</span> <span class="fu">convert</span>(<span class="dt">Array</span>{<span class="dt">Float32</span>,<span class="fl">4</span>}, <span class="fu">stack</span>(transform_img <span class="op">∘</span> dataset.load, ids; dims<span class="op">=</span><span class="fl">4</span>))</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> <span class="fu">convert</span>(<span class="dt">Matrix</span>{<span class="dt">Float32</span>}, <span class="fu">stack</span>(<span class="fu">get_labels</span>.(<span class="fu">Ref</span>(dataset.labels), ids); dims<span class="op">=</span><span class="fl">2</span>))</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> img_arrays, labels</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="bu">Base</span>.<span class="fu">length</span>(dataset<span class="op">::</span><span class="dt">GalaxyDataset</span>) <span class="op">=</span> <span class="fu">length</span>(dataset.ids)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>train_ids, test_ids <span class="op">=</span> <span class="fu">splitobs</span>(galaxy_data.GalaxyID, at<span class="op">=</span><span class="fl">0.8</span>, shuffle<span class="op">=</span><span class="cn">true</span>)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Create training and testing datasets</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>train_dataset <span class="op">=</span> <span class="fu">GalaxyDataset</span>(</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    train_ids,</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    galaxy_data,</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    load_processed_img</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>test_dataset <span class="op">=</span> <span class="fu">GalaxyDataset</span>(</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    test_ids,</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    galaxy_data,</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    load_processed_img</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<div class="ansi-escaped-output">
<pre>GalaxyDataset{SubArray{Int64, 1, SentinelArrays.ChainedVector{Int64, Vector{Int64}}, Tuple{Vector{Int64}}, false}, DataFrame, typeof(load_processed_img)}([665337, 601098, 929447, 168280, 575960, 874079, 447302, 159846, 484149, 576176  …  576620, 625128, 646198, 447787, 751400, 604771, 711171, 624185, 879464, 335462], <span class="ansi-bold">61578×38 DataFrame</span>
<span class="ansi-bold">   Row </span>│<span class="ansi-bold"> GalaxyID </span><span class="ansi-bold"> Class1.1 </span><span class="ansi-bold"> Class1.2 </span><span class="ansi-bold"> Class1.3 </span><span class="ansi-bold"> Class2.1  </span><span class="ansi-bold"> Class2.2 </span><span class="ansi-bold"> Class3.1</span> ⋯
       │<span class="ansi-bright-black-fg"> Int64    </span><span class="ansi-bright-black-fg"> Float32  </span><span class="ansi-bright-black-fg"> Float32  </span><span class="ansi-bright-black-fg"> Float32  </span><span class="ansi-bright-black-fg"> Float32   </span><span class="ansi-bright-black-fg"> Float32  </span><span class="ansi-bright-black-fg"> Float32 </span> ⋯
───────┼────────────────────────────────────────────────────────────────────────
     1 │   100008  0.383147  0.616853  0.0       0.0        0.616853  0.038452 ⋯
     2 │   100023  0.327001  0.663777  0.009222  0.0311783  0.632599  0.46737
     3 │   100053  0.765717  0.177352  0.056931  0.0        0.177352  0.0
     4 │   100078  0.693377  0.238564  0.068059  0.0        0.238564  0.109493
     5 │   100090  0.933839  0.0       0.066161  0.0        0.0       0.0      ⋯
     6 │   100122  0.738832  0.238159  0.023009  0.0        0.238159  0.0
     7 │   100123  0.462492  0.456033  0.081475  0.0        0.456033  0.0
     8 │   100128  0.687783  0.288344  0.023873  0.0        0.288344  0.069098
   ⋮   │    ⋮         ⋮         ⋮         ⋮          ⋮         ⋮          ⋮    ⋱
 61572 │   999900  0.460239  0.511396  0.028365  0.109439   0.401957  0.0      ⋯
 61573 │   999936  0.545443  0.454557  0.0       0.0568196  0.397737  0.126909
 61574 │   999948  0.510379  0.489621  0.0       0.0592069  0.430414  0.0
 61575 │   999950  0.901216  0.098784  0.0       0.0        0.098784  0.0
 61576 │   999958  0.202841  0.777376  0.019783  0.116962   0.660414  0.067245 ⋯
 61577 │   999964  0.091     0.909     0.0       0.04545    0.86355   0.022452
 61578 │   999967  0.767     0.14      0.093     0.0        0.14      0.0
<span class="ansi-cyan-fg">                                               32 columns and 61563 rows omitted</span>, load_processed_img)</pre>
</div>
</div>
</div>
<section id="create-dataloaders-with-batch-size" class="level4">
<h4 class="anchored" data-anchor-id="create-dataloaders-with-batch-size">6. Create DataLoaders with batch size</h4>
<div id="18" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>train_loader <span class="op">=</span> <span class="fu">DataLoader</span>(train_dataset, batchsize<span class="op">=</span><span class="fl">32</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>test_loader <span class="op">=</span> <span class="fu">DataLoader</span>(test_dataset, batchsize<span class="op">=</span><span class="fl">32</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>385-element DataLoader(::GalaxyDataset{SubArray{Int64, 1, SentinelArrays.ChainedVector{Int64, Vector{Int64}}, Tuple{Vector{Int64}}, false}, DataFrame, typeof(load_processed_img)}, batchsize=32)
  with first element:
  (64×64×3×32 Array{Float32, 4}, 37×32 Matrix{Float32},)</code></pre>
</div>
</div>
<div id="20" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_images</span>(highest_prob_df, load_processed_img)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-11-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="step-3-defining-a-cnn" class="level2">
<h2 class="anchored" data-anchor-id="step-3-defining-a-cnn">Step 3: Defining a CNN</h2>
<blockquote class="blockquote">
<p>The data is now ready to be analyzed. Next, we need to define a CNN that will take the 64x64 images with 3 colors as input and give us a probability for the 37 classes as output. To start, define a CNN with the following elements (this is an adaptation of the CNN we used with the FashionMNIST data):</p>
</blockquote>
<ol type="1">
<li>Convolution layer with 6 output filters, a 5-pixel kernel, and a padding of 3.<br>
</li>
<li>Convolution layer with 16 output filters, a 5-pixel kernel, and a padding of 3.<br>
</li>
<li>Fully connected layer with 120 output neurons<br>
</li>
<li>Fully connected layer with 84 output neurons<br>
</li>
<li>Final layer with logits for the 37 classes.<br>
</li>
<li>We need to convert the 37 classes to probabilities. Which function seen in class allows us to convert logits to a value between 0 and 1? (Note: The probabilities are not mutually exclusive!)</li>
</ol>
<blockquote class="blockquote">
<p>After each convolution layer, use batch normalization, ReLU activation, and pooling with a kernel size of 2.
Between the fully connected layers, use a ReLU activation function (except at the output of the final layer). Don’t forget to flatten the images between the last convolution layer and the first fully connected layer.</p>
</blockquote>
<p>In the report, explain the general structure and function of the different layers. Submit the code that defines this CNN.</p>
<div id="22" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">get_output_width</span>(width, kernel_size; stride<span class="op">=</span><span class="fl">1</span>, padding<span class="op">=</span><span class="fl">0</span>, dilation<span class="op">=</span><span class="fl">1</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">floor</span>(<span class="dt">Int</span>,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>        (width <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> padding <span class="op">-</span> dilation <span class="op">*</span> (kernel_size <span class="op">-</span> <span class="fl">1</span>) <span class="op">-</span> <span class="fl">1</span>) <span class="op">/</span> stride <span class="op">+</span> <span class="fl">1</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Chain</span>: @chain</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="pp">@chain</span> <span class="fl">64</span> <span class="cf">begin</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">get_output_width</span>(<span class="fl">5</span>; padding<span class="op">=</span><span class="fl">3</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">get_output_width</span>(<span class="fl">2</span>; stride<span class="op">=</span><span class="fl">2</span>)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">get_output_width</span>(<span class="fl">5</span>; padding<span class="op">=</span><span class="fl">3</span>)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">get_output_width</span>(<span class="fl">2</span>; stride<span class="op">=</span><span class="fl">2</span>)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>17</code></pre>
</div>
</div>
<div id="24" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Random</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Lux</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Optimisers</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Zygote</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> <span class="bu">Random</span>.<span class="fu">default_rng</span>()</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="bu">Random</span>.<span class="fu">seed!</span>(rng, <span class="fl">42</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">build_cnn_model</span>(; num_classes<span class="op">=</span><span class="fl">37</span>, pad<span class="op">=</span><span class="fl">3</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">Chain</span>(</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Chain</span>(</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>            <span class="fu">Conv</span>((<span class="fl">5</span>, <span class="fl">5</span>), <span class="fl">3</span> <span class="op">=&gt;</span> <span class="fl">6</span>; pad),</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>            <span class="fu">BatchNorm</span>(<span class="fl">6</span>, relu),</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>            <span class="fu">MaxPool</span>((<span class="fl">2</span>, <span class="fl">2</span>)),</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Chain</span>(</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>            <span class="fu">Conv</span>((<span class="fl">5</span>, <span class="fl">5</span>), <span class="fl">6</span> <span class="op">=&gt;</span> <span class="fl">16</span>; pad),</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>            <span class="fu">BatchNorm</span>(<span class="fl">16</span>, relu),</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>            <span class="fu">MaxPool</span>((<span class="fl">2</span>, <span class="fl">2</span>)),</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">FlattenLayer</span>(; N<span class="op">=</span><span class="fl">3</span>),</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Chain</span>(</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>            <span class="fu">Dense</span>(<span class="fl">4624</span> <span class="op">=&gt;</span> <span class="fl">120</span>, relu),</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>            <span class="fu">Dense</span>(<span class="fl">120</span> <span class="op">=&gt;</span> <span class="fl">84</span>, relu),</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>            <span class="fu">Dense</span>(<span class="fl">84</span> <span class="op">=&gt;</span> num_classes, sigmoid);</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>            name<span class="op">=</span><span class="st">"Fully connected layer"</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the model</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> <span class="fu">build_cnn_model</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<div class="ansi-escaped-output">
<pre>Chain(
    layer_1 = Chain(
        layer_1 = Conv((5, 5), 3 =&gt; 6, pad=3),  <span class="ansi-bright-black-fg"># 456 parameters</span>
        layer_2 = BatchNorm(6, relu, affine=true, track_stats=true),  <span class="ansi-bright-black-fg"># 12 parameters</span><span class="ansi-bright-black-fg">, plus 13</span>
        layer_3 = MaxPool((2, 2)),
    ),
    layer_2 = Chain(
        layer_1 = Conv((5, 5), 6 =&gt; 16, pad=3),  <span class="ansi-bright-black-fg"># 2_416 parameters</span>
        layer_2 = BatchNorm(16, relu, affine=true, track_stats=true),  <span class="ansi-bright-black-fg"># 32 parameters</span><span class="ansi-bright-black-fg">, plus 33</span>
        layer_3 = MaxPool((2, 2)),
    ),
    layer_3 = FlattenLayer{Static.StaticInt{3}}(static(3)),
    layer_4 = Fully connected layer(
        layer_1 = Dense(4624 =&gt; 120, relu),  <span class="ansi-bright-black-fg"># 555_000 parameters</span>
        layer_2 = Dense(120 =&gt; 84, relu),  <span class="ansi-bright-black-fg"># 10_164 parameters</span>
        layer_3 = Dense(84 =&gt; 37, σ),   <span class="ansi-bright-black-fg"># 3_145 parameters</span>
    ),
) <span class="ansi-bright-black-fg">        # Total: </span>571_225 parameters,
<span class="ansi-bright-black-fg">          #        plus </span>46 states.</pre>
</div>
</div>
</div>
<p>Create dummy input to test the model</p>
<div id="26" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>ps, st <span class="op">=</span> Lux.<span class="fu">setup</span>(rng, model);</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="fu">rand</span>(rng, <span class="dt">Float32</span>, <span class="fl">64</span>, <span class="fl">64</span>, <span class="fl">3</span>, <span class="fl">2</span>)  <span class="co"># (height, width, channels, batch_size)</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">model</span>(x, ps, Lux.<span class="fu">testmode</span>(st))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>(Float32[0.5226176 0.5963492; 0.7555507 0.75195336; … ; 0.43180552 0.5062954; 0.64954376 0.6692772], (layer_1 = (layer_1 = NamedTuple(), layer_2 = (running_mean = Float32[0.0, 0.0, 0.0, 0.0, 0.0, 0.0], running_var = Float32[1.0, 1.0, 1.0, 1.0, 1.0, 1.0], training = Val{false}()), layer_3 = NamedTuple()), layer_2 = (layer_1 = NamedTuple(), layer_2 = (running_mean = Float32[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], running_var = Float32[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0], training = Val{false}()), layer_3 = NamedTuple()), layer_3 = NamedTuple(), layer_4 = (layer_1 = NamedTuple(), layer_2 = NamedTuple(), layer_3 = NamedTuple())))</code></pre>
</div>
</div>
</section>
<section id="step-4-training-the-network" class="level2">
<h2 class="anchored" data-anchor-id="step-4-training-the-network">Step 4: Training the network</h2>
<blockquote class="blockquote">
<p>Once the network is defined, it must be trained to recognize galaxies. Adapt the training and testing loops we saw in class. Use the following hyperparameters, then train the model.</p>
</blockquote>
<ol type="1">
<li>MSE objective function</li>
<li>Adam optimizer</li>
<li>6 epochs</li>
</ol>
<blockquote class="blockquote">
<p>Record the value of the objective function for each epoch, for the training and test data separately. Once training is complete, display the evolution of the objective function for the training and test data.</p>
</blockquote>
<p>In the report, explain the training process and display the evolution of the objective function. Submit the code used to train the network.</p>
<div id="28" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Printf</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">evaluate_model</span>(model, ps, st, dataloader, lossfn)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    total_loss <span class="op">=</span> <span class="fl">0.0f0</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    total_batches <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    st <span class="op">=</span> Lux.<span class="fu">testmode</span>(st)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@showprogress</span> <span class="st">"Testing..."</span> <span class="cf">for</span> (x, y) <span class="kw">in</span> dataloader</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Forward pass</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> <span class="fu">first</span>(<span class="fu">model</span>(x, ps, st))</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute loss</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> <span class="fu">lossfn</span>(y_pred, y)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>        total_loss <span class="op">+=</span> loss</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>        total_batches <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> total_loss <span class="op">/</span> total_batches</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">init_evaluate_model</span>(model, ps, st, train_loader, test_loader, lossfn<span class="op">=</span><span class="fu">MSELoss</span>(); verbose<span class="op">=</span><span class="cn">true</span>)</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    train_loss <span class="op">=</span> <span class="fu">evaluate_model</span>(model, ps, st, train_loader, lossfn)</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    test_loss <span class="op">=</span> <span class="fu">evaluate_model</span>(model, ps, st, test_loader, lossfn)</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> verbose</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@printf</span> <span class="st">"Initial: Train Loss %4.5f, Test Loss %4.5f</span><span class="sc">\n</span><span class="st">"</span> train_loss test_loss</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> train_loss, test_loss</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>init_evaluate_model (generic function with 2 methods)</code></pre>
</div>
</div>
<div id="30" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">JLD2</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">train_model!</span>(model, ps, st, train_loader, test_loader; op<span class="op">=</span><span class="fu">Adam</span>(<span class="fl">0.003f0</span>), epochs<span class="op">=</span><span class="fl">6</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    train_state <span class="op">=</span> Training.<span class="fu">TrainState</span>(model, ps, st, op)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    ad <span class="op">=</span> <span class="fu">AutoZygote</span>()</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    lossfn <span class="op">=</span> <span class="fu">MSELoss</span>()</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize arrays to store losses</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    train_losses <span class="op">=</span> <span class="dt">Float32</span>[]</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    test_losses <span class="op">=</span> <span class="dt">Float32</span>[]</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>epochs</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Training phase</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>        total_loss <span class="op">=</span> <span class="fl">0.0f0</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>        total_batches <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@showprogress</span> <span class="st">"Training..."</span> <span class="cf">for</span> data <span class="kw">in</span> train_loader</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>            _, loss, _, train_state <span class="op">=</span> Training.<span class="fu">single_train_step!</span>(</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>                ad, lossfn,</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>                data, train_state</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>            total_loss <span class="op">+=</span> loss</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>            total_batches <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate average training loss for this epoch</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>        train_loss <span class="op">=</span> total_loss <span class="op">/</span> total_batches</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>        <span class="fu">push!</span>(train_losses, train_loss)</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>        test_loss <span class="op">=</span> <span class="fu">evaluate_model</span>(model, train_state.parameters, train_state.states, test_loader, lossfn)</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>        <span class="fu">push!</span>(test_losses, test_loss)</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@printf</span> <span class="st">"Epoch [%3d]: Train Loss %4.5f, Test Loss %4.5f</span><span class="sc">\n</span><span class="st">"</span> epoch train_loss test_loss</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> train_state, train_losses, test_losses</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a><span class="co"># load file if it exists</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="fl">6</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="fu">isfile</span>(<span class="st">"trained_model.jld2"</span>)</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@load</span> <span class="st">"trained_model.jld2"</span> ps_trained st_trained train_losses test_losses</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluate initial losses before training</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>    initial_train_loss, initial_test_loss <span class="op">=</span> <span class="fu">init_evaluate_model</span>(model, ps, st, train_loader, test_loader; verbose<span class="op">=</span><span class="cn">true</span>)</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train the model and record both training and testing losses</span></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>    train_state, train_losses, test_losses <span class="op">=</span> <span class="fu">train_model!</span>(model, ps, st, train_loader, test_loader; epochs)</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Append training losses to the initial losses</span></span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prepend!</span>(train_losses, initial_train_loss)</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prepend!</span>(test_losses, initial_test_loss)</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>    ps_trained, st_trained <span class="op">=</span> train_state.parameters, train_state.states</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@save</span> <span class="st">"trained_model.jld2"</span> ps_trained st_trained train_losses test_losses</span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>4-element Vector{Symbol}:
 :ps_trained
 :st_trained
 :train_losses
 :test_losses</code></pre>
</div>
</div>
<div id="32" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the evolution of the training and testing loss</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> <span class="fu">Figure</span>()</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">1</span>, <span class="fl">1</span>],</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    xlabel<span class="op">=</span><span class="st">"Epoch"</span>,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">"Mean Squared Error"</span>,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Training and Testing Loss Evolution"</span>,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="fu">scatterlines!</span>(<span class="fl">0</span><span class="op">:</span>epochs, train_losses, linewidth<span class="op">=</span><span class="fl">3</span>, color<span class="op">=:</span>blue, label<span class="op">=</span><span class="st">"Training Loss"</span>)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="fu">scatterlines!</span>(<span class="fl">0</span><span class="op">:</span>epochs, test_losses, linewidth<span class="op">=</span><span class="fl">3</span>, color<span class="op">=:</span>red, label<span class="op">=</span><span class="st">"Testing Loss"</span>)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="fu">axislegend</span>(ax, position<span class="op">=:</span>rt)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>fig</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-17-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="step-5-model-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="step-5-model-evaluation">Step 5: Model evaluation</h2>
<blockquote class="blockquote">
<p>With the trained model, what is the RMSE value for the test data? For reference, a simple solution that uses the average color of the 100 central pixels (10x10) gives an RMSE of 0.16194. How does your neural network compare to this method?
The dataset we are studying was used in a Kaggle competition several years ago: https://www.kaggle.com/c/galaxy-zoo-the-galaxy-challenge. Several people have attempted to find a solution that gives the smallest possible RMSE. The solutions are ranked in the Leaderboard tab. How does the solution obtained in Step 4 rank?
In the report, report the RMSE and discuss the comparison with a simplistic method (central pixels). Submit the code used to calculate the RMSE.</p>
</blockquote>
<div id="34" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>cnn_rmse <span class="op">=</span> <span class="fu">sqrt</span>(test_losses[<span class="kw">end</span>])</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>simple_rmse_ref <span class="op">=</span> <span class="fl">0.16194</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>improvement <span class="op">=</span> <span class="fu">round</span>(((simple_rmse_ref <span class="op">-</span> cnn_rmse) <span class="op">/</span> simple_rmse_ref <span class="op">*</span> <span class="fl">100</span>), digits<span class="op">=</span><span class="fl">2</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="pp">@info</span> <span class="st">"CNN RMSE on train data: "</span> <span class="fu">sqrt</span>(train_losses[<span class="kw">end</span>])</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="pp">@info</span> <span class="st">"CNN RMSE on test data: "</span> <span class="fu">sqrt</span>(test_losses[<span class="kw">end</span>])</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="pp">@info</span> <span class="st">"Improvement: </span><span class="sc">$</span>(improvement)<span class="st"> %"</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> cnn_rmse <span class="op">&lt;</span> simple_rmse_ref</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Our CNN model outperforms the simple central pixels method!"</span>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"This demonstrates that the CNN can learn complex patterns across the entire image rather than just using the central region."</span>)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Our CNN model doesn't outperform the simple method yet."</span>)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"This could be due to several factors:"</span>)</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"1. Limited training epochs"</span>)</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"2. Model architecture might need optimization"</span>)</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"3. Learning rate or other hyperparameters might need tuning"</span>)</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-cyan-fg ansi-bold">┌ </span><span class="ansi-cyan-fg ansi-bold">Info: </span>CNN RMSE on train data: 
<span class="ansi-cyan-fg ansi-bold">└ </span>  sqrt(train_losses[end]) = 0.108268715f0
<span class="ansi-cyan-fg ansi-bold">┌ </span><span class="ansi-cyan-fg ansi-bold">Info: </span>CNN RMSE on test data: 
<span class="ansi-cyan-fg ansi-bold">└ </span>  sqrt(test_losses[end]) = 0.11684338f0
<span class="ansi-cyan-fg ansi-bold">[ </span><span class="ansi-cyan-fg ansi-bold">Info: </span>Improvement: 27.85 %

Our CNN model outperforms the simple central pixels method!
This demonstrates that the CNN can learn complex patterns across the entire image rather than just using the central region.
</pre>
</div>
</div>
</div>
</section>
<section id="step-6-model-modification" class="level2">
<h2 class="anchored" data-anchor-id="step-6-model-modification">Step 6: Model modification</h2>
<blockquote class="blockquote">
<p>In class, we saw different ways to improve model performance (regularization, dropout, data augmentation, adding layers, changing the model configuration or training process). Modify the model and evaluate the effect of the changes on training. You can also completely redefine the model, either using a known architecture (e.g., ResNet) or an original architecture. How does the performance compare to that of Steps 3-4-5? Can you explain why the changes had this effect?</p>
</blockquote>
<p>Grading scale:</p>
<ol type="1">
<li>Any simple modification to the model ensures at least 6/10</li>
<li>Additional modifications are worth 1 point each, up to a total of 10/10</li>
<li>Rewriting a completely different architecture with a similar or larger number of parameters and at least two hidden layers automatically earns full points (10/10)</li>
<li>Model performance does not earn any additional points. The goal is really to get you to explore possible modifications! In the report, indicate what modifications you made, the effect they had, and why they had that effect. Also include a comparison of the RMSE with the previous steps. Submit the modified code for this section.</li>
</ol>
<section id="using-resnet-for-galaxy-classification" class="level3">
<h3 class="anchored" data-anchor-id="using-resnet-for-galaxy-classification">Using ResNet for Galaxy Classification</h3>
<div id="36" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Boltz</span>, <span class="bu">Metalhead</span>, <span class="bu">Lux</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to create a modified ResNet for our galaxy classification task</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">build_resnet_model</span>(; num_classes<span class="op">=</span><span class="fl">37</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the base ResNet-18 model</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    resnet <span class="op">=</span> Vision.<span class="fu">ResNet</span>(<span class="fl">18</span>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract all layers except the final classification layer</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    base_layers <span class="op">=</span> resnet.layer.layer_1</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a new final layer for our 37-class multi-label classification</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    final_layer <span class="op">=</span> <span class="fu">Chain</span>(</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">AdaptiveMeanPool</span>((<span class="fl">1</span>, <span class="fl">1</span>)),</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">FlattenLayer</span>(; N<span class="op">=</span><span class="fl">3</span>),</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Dense</span>(<span class="fl">512</span> <span class="op">=&gt;</span> num_classes, sigmoid)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine the base layers with our new classification head</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">Chain</span>(base_layers, final_layer)</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the ResNet model</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>resnet_model <span class="op">=</span> <span class="fu">build_resnet_model</span>()</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>resnet_ps, resnet_st <span class="op">=</span> Lux.<span class="fu">setup</span>(rng, resnet_model)</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Show model structure</span></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>resnet_model</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<div class="ansi-escaped-output">
<pre>Chain(
    layer_1 = Chain(
        layer_1 = Chain(
            layer_1 = Conv((7, 7), 3 =&gt; 64, pad=3, stride=2, use_bias=false),  <span class="ansi-bright-black-fg"># 9_408 parameters</span>
            layer_2 = BatchNorm(64, relu, affine=true, track_stats=true),  <span class="ansi-bright-black-fg"># 128 parameters</span><span class="ansi-bright-black-fg">, plus 129</span>
            layer_3 = MaxPool((3, 3), pad=1, stride=2),
        ),
        layer_2 = Chain(
            layer_1 = Parallel(
                connection = addact(NNlib.relu, ...),
                layer_1 = NoOpLayer(),
                layer_2 = Chain(
                    layer_1 = Conv((3, 3), 64 =&gt; 64, pad=1, use_bias=false),  <span class="ansi-bright-black-fg"># 36_864 parameters</span>
                    layer_2 = BatchNorm(64, affine=true, track_stats=true),  <span class="ansi-bright-black-fg"># 128 parameters</span><span class="ansi-bright-black-fg">, plus 129</span>
                    layer_3 = WrappedFunction(relu),
                    layer_4 = Conv((3, 3), 64 =&gt; 64, pad=1, use_bias=false),  <span class="ansi-bright-black-fg"># 36_864 parameters</span>
                    layer_5 = BatchNorm(64, affine=true, track_stats=true),  <span class="ansi-bright-black-fg"># 128 parameters</span><span class="ansi-bright-black-fg">, plus 129</span>
                ),
            ),
            layer_2 = Parallel(
                connection = addact(NNlib.relu, ...),
                layer_1 = NoOpLayer(),
                layer_2 = Chain(
                    layer_1 = Conv((3, 3), 64 =&gt; 64, pad=1, use_bias=false),  <span class="ansi-bright-black-fg"># 36_864 parameters</span>
                    layer_2 = BatchNorm(64, affine=true, track_stats=true),  <span class="ansi-bright-black-fg"># 128 parameters</span><span class="ansi-bright-black-fg">, plus 129</span>
                    layer_3 = WrappedFunction(relu),
                    layer_4 = Conv((3, 3), 64 =&gt; 64, pad=1, use_bias=false),  <span class="ansi-bright-black-fg"># 36_864 parameters</span>
                    layer_5 = BatchNorm(64, affine=true, track_stats=true),  <span class="ansi-bright-black-fg"># 128 parameters</span><span class="ansi-bright-black-fg">, plus 129</span>
                ),
            ),
        ),
        layer_3 = Chain(
            layer_1 = Parallel(
                connection = addact(NNlib.relu, ...),
                layer_1 = Chain(
                    layer_1 = Conv((1, 1), 64 =&gt; 128, stride=2, use_bias=false),  <span class="ansi-bright-black-fg"># 8_192 parameters</span>
                    layer_2 = BatchNorm(128, affine=true, track_stats=true),  <span class="ansi-bright-black-fg"># 256 parameters</span><span class="ansi-bright-black-fg">, plus 257</span>
                ),
                layer_2 = Chain(
                    layer_1 = Conv((3, 3), 64 =&gt; 128, pad=1, stride=2, use_bias=false),  <span class="ansi-bright-black-fg"># 73_728 parameters</span>
                    layer_2 = BatchNorm(128, affine=true, track_stats=true),  <span class="ansi-bright-black-fg"># 256 parameters</span><span class="ansi-bright-black-fg">, plus 257</span>
                    layer_3 = WrappedFunction(relu),
                    layer_4 = Conv((3, 3), 128 =&gt; 128, pad=1, use_bias=false),  <span class="ansi-bright-black-fg"># 147_456 parameters</span>
                    layer_5 = BatchNorm(128, affine=true, track_stats=true),  <span class="ansi-bright-black-fg"># 256 parameters</span><span class="ansi-bright-black-fg">, plus 257</span>
                ),
            ),
            layer_2 = Parallel(
                connection = addact(NNlib.relu, ...),
                layer_1 = NoOpLayer(),
                layer_2 = Chain(
                    layer_1 = Conv((3, 3), 128 =&gt; 128, pad=1, use_bias=false),  <span class="ansi-bright-black-fg"># 147_456 parameters</span>
                    layer_2 = BatchNorm(128, affine=true, track_stats=true),  <span class="ansi-bright-black-fg"># 256 parameters</span><span class="ansi-bright-black-fg">, plus 257</span>
                    layer_3 = WrappedFunction(relu),
                    layer_4 = Conv((3, 3), 128 =&gt; 128, pad=1, use_bias=false),  <span class="ansi-bright-black-fg"># 147_456 parameters</span>
                    layer_5 = BatchNorm(128, affine=true, track_stats=true),  <span class="ansi-bright-black-fg"># 256 parameters</span><span class="ansi-bright-black-fg">, plus 257</span>
                ),
            ),
        ),
        layer_4 = Chain(
            layer_1 = Parallel(
                connection = addact(NNlib.relu, ...),
                layer_1 = Chain(
                    layer_1 = Conv((1, 1), 128 =&gt; 256, stride=2, use_bias=false),  <span class="ansi-bright-black-fg"># 32_768 parameters</span>
                    layer_2 = BatchNorm(256, affine=true, track_stats=true),  <span class="ansi-bright-black-fg"># 512 parameters</span><span class="ansi-bright-black-fg">, plus 513</span>
                ),
                layer_2 = Chain(
                    layer_1 = Conv((3, 3), 128 =&gt; 256, pad=1, stride=2, use_bias=false),  <span class="ansi-bright-black-fg"># 294_912 parameters</span>
                    layer_2 = BatchNorm(256, affine=true, track_stats=true),  <span class="ansi-bright-black-fg"># 512 parameters</span><span class="ansi-bright-black-fg">, plus 513</span>
                    layer_3 = WrappedFunction(relu),
                    layer_4 = Conv((3, 3), 256 =&gt; 256, pad=1, use_bias=false),  <span class="ansi-bright-black-fg"># 589_824 parameters</span>
                    layer_5 = BatchNorm(256, affine=true, track_stats=true),  <span class="ansi-bright-black-fg"># 512 parameters</span><span class="ansi-bright-black-fg">, plus 513</span>
                ),
            ),
            layer_2 = Parallel(
                connection = addact(NNlib.relu, ...),
                layer_1 = NoOpLayer(),
                layer_2 = Chain(
                    layer_1 = Conv((3, 3), 256 =&gt; 256, pad=1, use_bias=false),  <span class="ansi-bright-black-fg"># 589_824 parameters</span>
                    layer_2 = BatchNorm(256, affine=true, track_stats=true),  <span class="ansi-bright-black-fg"># 512 parameters</span><span class="ansi-bright-black-fg">, plus 513</span>
                    layer_3 = WrappedFunction(relu),
                    layer_4 = Conv((3, 3), 256 =&gt; 256, pad=1, use_bias=false),  <span class="ansi-bright-black-fg"># 589_824 parameters</span>
                    layer_5 = BatchNorm(256, affine=true, track_stats=true),  <span class="ansi-bright-black-fg"># 512 parameters</span><span class="ansi-bright-black-fg">, plus 513</span>
                ),
            ),
        ),
        layer_5 = Chain(
            layer_1 = Parallel(
                connection = addact(NNlib.relu, ...),
                layer_1 = Chain(
                    layer_1 = Conv((1, 1), 256 =&gt; 512, stride=2, use_bias=false),  <span class="ansi-bright-black-fg"># 131_072 parameters</span>
                    layer_2 = BatchNorm(512, affine=true, track_stats=true),  <span class="ansi-bright-black-fg"># 1_024 parameters</span><span class="ansi-bright-black-fg">, plus 1_025</span>
                ),
                layer_2 = Chain(
                    layer_1 = Conv((3, 3), 256 =&gt; 512, pad=1, stride=2, use_bias=false),  <span class="ansi-bright-black-fg"># 1_179_648 parameters</span>
                    layer_2 = BatchNorm(512, affine=true, track_stats=true),  <span class="ansi-bright-black-fg"># 1_024 parameters</span><span class="ansi-bright-black-fg">, plus 1_025</span>
                    layer_3 = WrappedFunction(relu),
                    layer_4 = Conv((3, 3), 512 =&gt; 512, pad=1, use_bias=false),  <span class="ansi-bright-black-fg"># 2_359_296 parameters</span>
                    layer_5 = BatchNorm(512, affine=true, track_stats=true),  <span class="ansi-bright-black-fg"># 1_024 parameters</span><span class="ansi-bright-black-fg">, plus 1_025</span>
                ),
            ),
            layer_2 = Parallel(
                connection = addact(NNlib.relu, ...),
                layer_1 = NoOpLayer(),
                layer_2 = Chain(
                    layer_1 = Conv((3, 3), 512 =&gt; 512, pad=1, use_bias=false),  <span class="ansi-bright-black-fg"># 2_359_296 parameters</span>
                    layer_2 = BatchNorm(512, affine=true, track_stats=true),  <span class="ansi-bright-black-fg"># 1_024 parameters</span><span class="ansi-bright-black-fg">, plus 1_025</span>
                    layer_3 = WrappedFunction(relu),
                    layer_4 = Conv((3, 3), 512 =&gt; 512, pad=1, use_bias=false),  <span class="ansi-bright-black-fg"># 2_359_296 parameters</span>
                    layer_5 = BatchNorm(512, affine=true, track_stats=true),  <span class="ansi-bright-black-fg"># 1_024 parameters</span><span class="ansi-bright-black-fg">, plus 1_025</span>
                ),
            ),
        ),
    ),
    layer_2 = Chain(
        layer_1 = AdaptiveMeanPool((1, 1)),
        layer_2 = FlattenLayer{Static.StaticInt{3}}(static(3)),
        layer_3 = Dense(512 =&gt; 37, σ),  <span class="ansi-bright-black-fg"># 18_981 parameters</span>
    ),
) <span class="ansi-bright-black-fg">        # Total: </span>11_195_493 parameters,
<span class="ansi-bright-black-fg">          #        plus </span>9_620 states.</pre>
</div>
</div>
</div>
</section>
<section id="testing-the-resnet-model-with-sample-data" class="level3">
<h3 class="anchored" data-anchor-id="testing-the-resnet-model-with-sample-data">Testing the ResNet Model with Sample Data</h3>
<div id="38" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create dummy input to test the model</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> <span class="fu">rand</span>(rng, <span class="dt">Float32</span>, <span class="fl">64</span>, <span class="fl">64</span>, <span class="fl">3</span>, <span class="fl">2</span>)  <span class="co"># (height, width, channels, batch_size)</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="fu">resnet_model</span>(x_test, resnet_ps, Lux.<span class="fu">testmode</span>(resnet_st))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>(Float32[0.30450302 0.30915502; 0.37083414 0.3660484; … ; 0.6346178 0.65124583; 0.30676535 0.30921096], (layer_1 = (layer_1 = (layer_1 = NamedTuple(), layer_2 = (running_mean = Float32[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0  …  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], running_var = Float32[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0  …  1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0], training = Val{false}()), layer_3 = NamedTuple()), layer_2 = (layer_1 = (layer_1 = NamedTuple(), layer_2 = (layer_1 = NamedTuple(), layer_2 = (running_mean = Float32[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0  …  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], running_var = Float32[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0  …  1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0], training = Val{false}()), layer_3 = NamedTuple(), layer_4 = NamedTuple(), layer_5 = (running_mean = Float32[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0  …  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], running_var = Float32[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0  …  1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0], training = Val{false}()))), layer_2 = (layer_1 = NamedTuple(), layer_2 = (layer_1 = NamedTuple(), layer_2 = (running_mean = Float32[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0  …  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], running_var = Float32[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0  …  1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0], training = Val{false}()), layer_3 = NamedTuple(), layer_4 = NamedTuple(), layer_5 = (running_mean = Float32[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0  …  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], running_var = Float32[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0  …  1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0], training = Val{false}())))), layer_3 = (layer_1 = (layer_1 = (layer_1 = NamedTuple(), layer_2 = (running_mean = Float32[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0  …  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], running_var = Float32[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0  …  1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0], training = Val{false}())), layer_2 = (layer_1 = NamedTuple(), layer_2 = (running_mean = Float32[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0  …  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], running_var = Float32[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0  …  1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0], training = Val{false}()), layer_3 = NamedTuple(), layer_4 = NamedTuple(), layer_5 = (running_mean = Float32[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0  …  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], running_var = Float32[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0  …  1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0], training = Val{false}()))), layer_2 = (layer_1 = NamedTuple(), layer_2 = (layer_1 = NamedTuple(), layer_2 = (running_mean = Float32[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0  …  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], running_var = Float32[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0  …  1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0], training = Val{false}()), layer_3 = NamedTuple(), layer_4 = NamedTuple(), layer_5 = (running_mean = Float32[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0  …  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], running_var = Float32[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0  …  1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0], training = Val{false}())))), layer_4 = (layer_1 = (layer_1 = (layer_1 = NamedTuple(), layer_2 = (running_mean = Float32[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0  …  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], running_var = Float32[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0  …  1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0], training = Val{false}())), layer_2 = (layer_1 = NamedTuple(), layer_2 = (running_mean = Float32[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0  …  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], running_var = Float32[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0  …  1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0], training = Val{false}()), layer_3 = NamedTuple(), layer_4 = NamedTuple(), layer_5 = (running_mean = Float32[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0  …  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], running_var = Float32[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0  …  1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0], training = Val{false}()))), layer_2 = (layer_1 = NamedTuple(), layer_2 = (layer_1 = NamedTuple(), layer_2 = (running_mean = Float32[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0  …  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], running_var = Float32[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0  …  1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0], training = Val{false}()), layer_3 = NamedTuple(), layer_4 = NamedTuple(), layer_5 = (running_mean = Float32[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0  …  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], running_var = Float32[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0  …  1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0], training = Val{false}())))), layer_5 = (layer_1 = (layer_1 = (layer_1 = NamedTuple(), layer_2 = (running_mean = Float32[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0  …  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], running_var = Float32[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0  …  1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0], training = Val{false}())), layer_2 = (layer_1 = NamedTuple(), layer_2 = (running_mean = Float32[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0  …  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], running_var = Float32[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0  …  1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0], training = Val{false}()), layer_3 = NamedTuple(), layer_4 = NamedTuple(), layer_5 = (running_mean = Float32[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0  …  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], running_var = Float32[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0  …  1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0], training = Val{false}()))), layer_2 = (layer_1 = NamedTuple(), layer_2 = (layer_1 = NamedTuple(), layer_2 = (running_mean = Float32[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0  …  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], running_var = Float32[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0  …  1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0], training = Val{false}()), layer_3 = NamedTuple(), layer_4 = NamedTuple(), layer_5 = (running_mean = Float32[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0  …  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], running_var = Float32[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0  …  1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0], training = Val{false}()))))), layer_2 = (layer_1 = NamedTuple(), layer_2 = NamedTuple(), layer_3 = NamedTuple())))</code></pre>
</div>
</div>
</section>
<section id="training-the-resnet-model" class="level3">
<h3 class="anchored" data-anchor-id="training-the-resnet-model">Training the ResNet Model</h3>
<div id="40" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>resnet_epochs <span class="op">=</span> <span class="fl">3</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate initial performance</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="fu">isfile</span>(<span class="st">"resnet_trained_model.jld2"</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@load</span> <span class="st">"resnet_trained_model.jld2"</span> resnet_ps_trained resnet_st_trained resnet_train_losses resnet_test_losses</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    initial_train_loss, initial_test_loss <span class="op">=</span> <span class="fu">init_evaluate_model</span>(resnet_model, resnet_ps, resnet_st, train_loader, test_loader)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@printf</span> <span class="st">"Initial ResNet: Train Loss %4.5f, Test Loss %4.5f</span><span class="sc">\n</span><span class="st">"</span> initial_train_loss initial_test_loss</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train the ResNet model</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    resnet_train_state, resnet_train_losses, resnet_test_losses <span class="op">=</span> <span class="fu">train_model!</span>(resnet_model, resnet_ps, resnet_st, train_loader, test_loader; op<span class="op">=</span><span class="fu">Adam</span>(<span class="fl">0.0005f0</span>), epochs<span class="op">=</span>resnet_epochs)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepend initial losses</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prepend!</span>(resnet_train_losses, initial_train_loss)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prepend!</span>(resnet_test_losses, initial_test_loss)</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the trained model</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    resnet_ps_trained, resnet_st_trained <span class="op">=</span> resnet_train_state.parameters, resnet_train_state.states</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@save</span> <span class="st">"resnet_trained_model.jld2"</span> resnet_ps_trained resnet_st_trained resnet_train_losses resnet_test_losses</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>4-element Vector{Symbol}:
 :resnet_ps_trained
 :resnet_st_trained
 :resnet_train_losses
 :resnet_test_losses</code></pre>
</div>
</div>
</section>
<section id="visualizing-resnet-training-results" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-resnet-training-results">Visualizing ResNet Training Results</h3>
<div id="42" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the evolution of the training and testing loss for ResNet</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> <span class="fu">Figure</span>()</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">1</span>, <span class="fl">1</span>],</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    xlabel<span class="op">=</span><span class="st">"Epoch"</span>,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">"Mean Squared Error"</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"ResNet Training and Testing Loss Evolution"</span>,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="fu">scatterlines!</span>(<span class="fl">0</span><span class="op">:</span>resnet_epochs, resnet_train_losses, linewidth<span class="op">=</span><span class="fl">3</span>, color<span class="op">=:</span>blue, label<span class="op">=</span><span class="st">"ResNet Training Loss"</span>)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="fu">scatterlines!</span>(<span class="fl">0</span><span class="op">:</span>resnet_epochs, resnet_test_losses, linewidth<span class="op">=</span><span class="fl">3</span>, color<span class="op">=:</span>red, label<span class="op">=</span><span class="st">"ResNet Testing Loss"</span>)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="fu">axislegend</span>(ax, position<span class="op">=:</span>rt)</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>fig</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-22-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="comparing-resnet-with-original-cnn" class="level3">
<h3 class="anchored" data-anchor-id="comparing-resnet-with-original-cnn">Comparing ResNet with Original CNN</h3>
<div id="44" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare RMSE of ResNet with the original CNN</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>resnet_rmse <span class="op">=</span> <span class="fu">sqrt</span>(resnet_test_losses[<span class="kw">end</span>])</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>cnn_rmse <span class="op">=</span> <span class="fu">sqrt</span>(test_losses[<span class="kw">end</span>])</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>simple_rmse_ref <span class="op">=</span> <span class="fl">0.16194</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="pp">@info</span> <span class="st">"Original CNN RMSE: "</span> cnn_rmse</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="pp">@info</span> <span class="st">"ResNet RMSE: "</span> resnet_rmse</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="pp">@info</span> <span class="st">"Reference simple method RMSE: "</span> simple_rmse_ref</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>resnet_improvement <span class="op">=</span> <span class="fu">round</span>(((cnn_rmse <span class="op">-</span> resnet_rmse) <span class="op">/</span> cnn_rmse <span class="op">*</span> <span class="fl">100</span>), digits<span class="op">=</span><span class="fl">2</span>)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> resnet_rmse <span class="op">&lt;</span> cnn_rmse</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">ResNet outperforms our original CNN by </span><span class="sc">$</span>(resnet_improvement)<span class="st">%!"</span>)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"The skip connections in ResNet help with gradient flow during training, </span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>        allowing the network to learn more complex features.<span class="st">"</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">ResNet doesn't outperform our original CNN."</span>)</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"This could be due to:"</span>)</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"1. Limited training time (ResNet is much larger and needs more epochs)"</span>)</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"2. Potential overfitting due to the larger model size"</span>)</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"3. The original CNN might be better suited for this specific dataset size"</span>)</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-cyan-fg ansi-bold">┌ </span><span class="ansi-cyan-fg ansi-bold">Info: </span>Original CNN RMSE: 
<span class="ansi-cyan-fg ansi-bold">└ </span>  cnn_rmse = 0.11684338f0
<span class="ansi-cyan-fg ansi-bold">┌ </span><span class="ansi-cyan-fg ansi-bold">Info: </span>ResNet RMSE: 
<span class="ansi-cyan-fg ansi-bold">└ </span>  resnet_rmse = 0.1086326f0
<span class="ansi-cyan-fg ansi-bold">┌ </span><span class="ansi-cyan-fg ansi-bold">Info: </span>Reference simple method RMSE: 
<span class="ansi-cyan-fg ansi-bold">└ </span>  simple_rmse_ref = 0.16194

ResNet outperforms our original CNN by 7.03%!
The skip connections in ResNet help with gradient flow during training, 
        allowing the network to learn more complex features.
</pre>
</div>
</div>
</div>
</section>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://www.kaggle.com/competitions/galaxy-zoo-the-galaxy-challenge/overview">Galaxy Zoo - The Galaxy Challenge | Kaggle</a></li>
<li><a href="https://sander.ai/2014/04/05/galaxy-zoo.html">My solution for the Galaxy Zoo challenge – Sander Dieleman</a></li>
</ul>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/Beforerr\.github\.io\/beforerr\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../../../../docs/courses/epss298_DataAnalysis/projects/proj1.html" class="pagination-link" aria-label="Project 1">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Project 1</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../../../../docs/courses/epss298_DataAnalysis/projects/proj2/CNN_script_EPS_SCI_298_example.html" class="pagination-link" aria-label="EPS-SCI-298 -- Convolutive Neural Networks">
        <span class="nav-page-text">EPS-SCI-298 – Convolutive Neural Networks</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> Project 2</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> Artificial Neural Networks and Deep Learning</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="an">engine:</span><span class="co"> julia</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>Images of galaxies obtained by the Sloan Digital Sky Survey (SDSS) have been classified by different  people through a participatory science process (see this article: https://arxiv.org/abs/1308.3496). There  are tens of thousands of classified examples. However, there are even more images, and classifying them  all by humans would take an enormous amount of time.</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>Our goal is therefore to develop a method to classify these images efficiently. We will use a convolutional neural network.  </span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>There are 37 non-exclusive categories (a galaxy can belong to more than one group). Since classification is sometimes ambiguous, participants did not always get the same answers. For each galaxy, the  classification result is therefore a probability of belonging to one of the categories. To train the network,  we will therefore use the mean squared error (MSE) to compare the probabilities given by the network.  </span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>MSE = \frac{1}{N} \sum_{n} (x_n - y_n)^2  </span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>For our final criterion (i.e., the one we will give as the answer at the very end), we will use the root of  the MSE (RMSE): $RMSE = \sqrt{MSE}$. This is therefore a regression problem (37 output values y that  we are trying to predict with the model), although the ultimate goal is to classify galaxies.</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 1: Data exploration</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>The images are in a folder called images_training_rev1. The probabilities for each class are in the file <span class="in">`training_solutions_rev1.csv`</span>. GalaxyID gives the identifier and each file in the folder corresponds  to a GalaxyID (with a .jpg extension). To familiarize yourself with the data:  </span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>(Optional, not to be displayed in the submission) Import the CSV file and display the first few rows</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Display the galaxy with the highest probability for each class (a .jpg or .png image). The format is: (dim1, dim2, C) where C=3 in our case. (Please include these images in a single figure, displaying the category name above each image).</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>Display the resulting figure with a brief explanation. Submit the code used to import the CSV and generate the figure.</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>dir <span class="op">=</span> <span class="st">"docs/courses/epss298_DataAnalysis/projects/proj2"</span></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="fu">isdir</span>(dir)</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cd</span>(dir)</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Pkg</span>.<span class="fu">activate</span>(<span class="st">"."</span>)</span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Pkg</span>.<span class="fu">resolve</span>()</span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Pkg</span>.<span class="fu">instantiate</span>()</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">CSV</span></span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">DataFrames</span></span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a>galaxy_data <span class="op">=</span> CSV.<span class="fu">read</span>(<span class="st">"data/training_solutions_rev1.csv"</span>, DataFrame)</span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a><span class="fu">transform!</span>(galaxy_data, <span class="fu">names</span>(galaxy_data, <span class="dt">Float64</span>) <span class="op">.=&gt;</span> x <span class="op">-&gt;</span> <span class="fu">Float32</span>.(x); renamecols<span class="op">=</span><span class="cn">false</span>)</span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a>class_columns <span class="op">=</span> <span class="fu">names</span>(galaxy_data)[<span class="fl">2</span><span class="op">:</span><span class="kw">end</span>]</span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a>DESCRIPTIONS <span class="op">=</span> [</span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Smooth"</span>, <span class="st">"Featured or disc"</span>, <span class="st">"Star or artifact"</span>,</span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Edge on"</span>, <span class="st">"Not edge on"</span>,</span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Bar through center"</span>, <span class="st">"No bar"</span>,</span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Spiral"</span>, <span class="st">"No Spiral"</span>,</span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">"No bulge"</span>, <span class="st">"Just noticeable bulge"</span>, <span class="st">"Obvious bulge"</span>, <span class="st">"Dominant bulge"</span>,</span>
<span id="cb33-59"><a href="#cb33-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Odd Feature"</span>, <span class="st">"No Odd Feature"</span>,</span>
<span id="cb33-60"><a href="#cb33-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Completely round"</span>, <span class="st">"In between"</span>, <span class="st">"Cigar shaped"</span>,</span>
<span id="cb33-61"><a href="#cb33-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Ring"</span>, <span class="st">"Lens or arc"</span>, <span class="st">"Disturbed"</span>, <span class="st">"Irregular"</span>, <span class="st">"Other"</span>, <span class="st">"Merger"</span>, <span class="st">"Dust lane"</span>,</span>
<span id="cb33-62"><a href="#cb33-62" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Rounded bulge"</span>, <span class="st">"Boxy bulge"</span>, <span class="st">"No bulge"</span>,</span>
<span id="cb33-63"><a href="#cb33-63" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Tightly wound arms"</span>, <span class="st">"Medium wound arms"</span>, <span class="st">"Loose wound arms"</span>,</span>
<span id="cb33-64"><a href="#cb33-64" aria-hidden="true" tabindex="-1"></a>    <span class="st">"1 Spiral Arm"</span>, <span class="st">"2 Spiral Arms"</span>, <span class="st">"3 Spiral Arms"</span>, <span class="st">"4 Spiral Arms"</span>,</span>
<span id="cb33-65"><a href="#cb33-65" aria-hidden="true" tabindex="-1"></a>    <span class="st">"More than four Spiral Arms"</span>, <span class="st">"Can't tell how many spiral arms"</span>,</span>
<span id="cb33-66"><a href="#cb33-66" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb33-67"><a href="#cb33-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-68"><a href="#cb33-68" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> CDICT <span class="op">=</span> <span class="fu">Dict</span>(class_columns <span class="op">.=&gt;</span> DESCRIPTIONS)</span>
<span id="cb33-69"><a href="#cb33-69" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-70"><a href="#cb33-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-73"><a href="#cb33-73" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb33-74"><a href="#cb33-74" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">FileIO</span></span>
<span id="cb33-75"><a href="#cb33-75" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Images</span></span>
<span id="cb33-76"><a href="#cb33-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-77"><a href="#cb33-77" aria-hidden="true" tabindex="-1"></a><span class="fu">load_img</span>(id) <span class="op">=</span> Images.<span class="fu">load</span>(<span class="fu">File</span><span class="dt">{format"JPEG"}</span>(<span class="st">"data/images_training_rev1/</span><span class="sc">$</span>(id)<span class="st">.jpg"</span>))</span>
<span id="cb33-78"><a href="#cb33-78" aria-hidden="true" tabindex="-1"></a><span class="fu">load_processed_img</span>(id) <span class="op">=</span> Images.<span class="fu">load</span>(<span class="fu">File</span><span class="dt">{format"JPEG"}</span>(<span class="st">"data/processed_images/</span><span class="sc">$</span>(id)<span class="st">.jpg"</span>))</span>
<span id="cb33-79"><a href="#cb33-79" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-80"><a href="#cb33-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-83"><a href="#cb33-83" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb33-84"><a href="#cb33-84" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the galaxy with highest probability for each class</span></span>
<span id="cb33-85"><a href="#cb33-85" aria-hidden="true" tabindex="-1"></a>highest_prob_df <span class="op">=</span> <span class="fu">DataFrame</span>(</span>
<span id="cb33-86"><a href="#cb33-86" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(class_columns) <span class="cf">do</span> Class</span>
<span id="cb33-87"><a href="#cb33-87" aria-hidden="true" tabindex="-1"></a>        max_idx <span class="op">=</span> <span class="fu">argmax</span>(galaxy_data[!, Class])</span>
<span id="cb33-88"><a href="#cb33-88" aria-hidden="true" tabindex="-1"></a>        GalaxyID <span class="op">=</span> galaxy_data[max_idx, <span class="op">:</span>GalaxyID]</span>
<span id="cb33-89"><a href="#cb33-89" aria-hidden="true" tabindex="-1"></a>        Probability <span class="op">=</span> galaxy_data[max_idx, Class]</span>
<span id="cb33-90"><a href="#cb33-90" aria-hidden="true" tabindex="-1"></a>        (; Class, GalaxyID, Probability)</span>
<span id="cb33-91"><a href="#cb33-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb33-92"><a href="#cb33-92" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-93"><a href="#cb33-93" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-94"><a href="#cb33-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-95"><a href="#cb33-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-96"><a href="#cb33-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-99"><a href="#cb33-99" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb33-100"><a href="#cb33-100" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">CairoMakie</span></span>
<span id="cb33-101"><a href="#cb33-101" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">CairoMakie</span>: Axis</span>
<span id="cb33-102"><a href="#cb33-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-103"><a href="#cb33-103" aria-hidden="true" tabindex="-1"></a>num_classes <span class="op">=</span> <span class="fu">nrow</span>(highest_prob_df)</span>
<span id="cb33-104"><a href="#cb33-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-105"><a href="#cb33-105" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">plot_images</span>(df, load; width<span class="op">=</span><span class="fl">150</span>, height<span class="op">=</span><span class="fl">150</span>)</span>
<span id="cb33-106"><a href="#cb33-106" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">Figure</span>()</span>
<span id="cb33-107"><a href="#cb33-107" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate grid dimensions - aim for roughly square layout</span></span>
<span id="cb33-108"><a href="#cb33-108" aria-hidden="true" tabindex="-1"></a>    ncols <span class="op">=</span> <span class="fu">ceil</span>(<span class="dt">Int</span>, <span class="fu">sqrt</span>(num_classes))</span>
<span id="cb33-109"><a href="#cb33-109" aria-hidden="true" tabindex="-1"></a>    nrows <span class="op">=</span> <span class="fu">ceil</span>(<span class="dt">Int</span>, num_classes <span class="op">/</span> ncols)</span>
<span id="cb33-110"><a href="#cb33-110" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load and display each image</span></span>
<span id="cb33-111"><a href="#cb33-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i, row) <span class="kw">in</span> <span class="fu">enumerate</span>(<span class="fu">eachrow</span>(highest_prob_df))</span>
<span id="cb33-112"><a href="#cb33-112" aria-hidden="true" tabindex="-1"></a>        row_idx <span class="op">=</span> <span class="fu">div</span>(i <span class="op">-</span> <span class="fl">1</span>, ncols) <span class="op">+</span> <span class="fl">1</span></span>
<span id="cb33-113"><a href="#cb33-113" aria-hidden="true" tabindex="-1"></a>        col_idx <span class="op">=</span> <span class="fu">mod</span>(i <span class="op">-</span> <span class="fl">1</span>, ncols) <span class="op">+</span> <span class="fl">1</span></span>
<span id="cb33-114"><a href="#cb33-114" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> <span class="st">"</span><span class="sc">$</span>(row.Class)<span class="sc">\n$</span>(CDICT[row.Class])<span class="sc">\n</span><span class="st">Prob: </span><span class="sc">$</span>(<span class="fu">round</span>(row.Probability, digits<span class="op">=</span><span class="fl">2</span>))<span class="st">"</span></span>
<span id="cb33-115"><a href="#cb33-115" aria-hidden="true" tabindex="-1"></a>        ax <span class="op">=</span> <span class="fu">Axis</span>(fig[row_idx, col_idx]; width, height, title,)</span>
<span id="cb33-116"><a href="#cb33-116" aria-hidden="true" tabindex="-1"></a>        <span class="fu">hidedecorations!</span>(ax)</span>
<span id="cb33-117"><a href="#cb33-117" aria-hidden="true" tabindex="-1"></a>        <span class="fu">image!</span>(ax, <span class="fu">load</span>(row.GalaxyID))</span>
<span id="cb33-118"><a href="#cb33-118" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb33-119"><a href="#cb33-119" aria-hidden="true" tabindex="-1"></a>    <span class="fu">resize_to_layout!</span>(fig)</span>
<span id="cb33-120"><a href="#cb33-120" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig</span>
<span id="cb33-121"><a href="#cb33-121" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb33-122"><a href="#cb33-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-123"><a href="#cb33-123" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_images</span>(highest_prob_df, load_img)</span>
<span id="cb33-124"><a href="#cb33-124" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-125"><a href="#cb33-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-126"><a href="#cb33-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-127"><a href="#cb33-127" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 2: Prepare the images</span></span>
<span id="cb33-128"><a href="#cb33-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-129"><a href="#cb33-129" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; The initial format of the images is not optimal. The format is large (424x424) and there is a lot of  empty space around the galaxies. Write a code that performs the following tasks:</span></span>
<span id="cb33-130"><a href="#cb33-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-131"><a href="#cb33-131" aria-hidden="true" tabindex="-1"></a><span class="fu">### Crop, resize, and save images</span></span>
<span id="cb33-132"><a href="#cb33-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-133"><a href="#cb33-133" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; 1. Crop the image to reduce the size by half around the center (212x212)</span></span>
<span id="cb33-134"><a href="#cb33-134" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; 2. Reduce the resolution so that the image has 64 pixels on each side</span>  </span>
<span id="cb33-135"><a href="#cb33-135" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; 3. Save all pre-processed images in a new folder</span>  </span>
<span id="cb33-136"><a href="#cb33-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-139"><a href="#cb33-139" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb33-140"><a href="#cb33-140" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">ProgressMeter</span></span>
<span id="cb33-141"><a href="#cb33-141" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">DataAugmentation</span></span>
<span id="cb33-142"><a href="#cb33-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-143"><a href="#cb33-143" aria-hidden="true" tabindex="-1"></a><span class="pp">@views</span> <span class="kw">function</span> <span class="fu">preprocess_image</span>(img; crop_size<span class="op">=</span><span class="fl">212</span>)</span>
<span id="cb33-144"><a href="#cb33-144" aria-hidden="true" tabindex="-1"></a>    cropped_img <span class="op">=</span> DataAugmentation.<span class="fu">apply</span>(</span>
<span id="cb33-145"><a href="#cb33-145" aria-hidden="true" tabindex="-1"></a>        DataAugmentation.<span class="fu">CenterCrop</span>((crop_size, crop_size)),</span>
<span id="cb33-146"><a href="#cb33-146" aria-hidden="true" tabindex="-1"></a>        DataAugmentation.<span class="fu">Image</span>(img)</span>
<span id="cb33-147"><a href="#cb33-147" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">|&gt;</span> DataAugmentation.itemdata</span>
<span id="cb33-148"><a href="#cb33-148" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">imresize</span>(cropped_img, (<span class="fl">64</span>, <span class="fl">64</span>))</span>
<span id="cb33-149"><a href="#cb33-149" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb33-150"><a href="#cb33-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-151"><a href="#cb33-151" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">process_and_save_images</span>(galaxy_ids, path)</span>
<span id="cb33-152"><a href="#cb33-152" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mkpath</span>(path)</span>
<span id="cb33-153"><a href="#cb33-153" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@showprogress</span> <span class="st">"Processing images..."</span> <span class="cf">for</span> id <span class="kw">in</span> galaxy_ids</span>
<span id="cb33-154"><a href="#cb33-154" aria-hidden="true" tabindex="-1"></a>        img_path <span class="op">=</span> <span class="fu">joinpath</span>(path, <span class="st">"</span><span class="sc">$</span>(id)<span class="st">.jpg"</span>)</span>
<span id="cb33-155"><a href="#cb33-155" aria-hidden="true" tabindex="-1"></a>        !<span class="fu">isfile</span>(img_path) <span class="op">&amp;&amp;</span> <span class="fu">save</span>(img_path, <span class="fu">preprocess_image</span>(<span class="fu">load_img</span>(id)))</span>
<span id="cb33-156"><a href="#cb33-156" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb33-157"><a href="#cb33-157" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb33-158"><a href="#cb33-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-159"><a href="#cb33-159" aria-hidden="true" tabindex="-1"></a><span class="co"># Process and save all images</span></span>
<span id="cb33-160"><a href="#cb33-160" aria-hidden="true" tabindex="-1"></a><span class="fu">process_and_save_images</span>(galaxy_data.GalaxyID, <span class="st">"data/processed_images"</span>)</span>
<span id="cb33-161"><a href="#cb33-161" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-162"><a href="#cb33-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-163"><a href="#cb33-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-164"><a href="#cb33-164" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data split, Dataset, and DataLoader</span></span>
<span id="cb33-165"><a href="#cb33-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-166"><a href="#cb33-166" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Using the GalaxyID from the CSV, randomly split the data into two subsets: training and testing.  We want 20% of the images to be used exclusively for testing. </span>
<span id="cb33-167"><a href="#cb33-167" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>Define a Dataset that can import the data and probabilities for each class (one for training, one for testing).</span>
<span id="cb33-168"><a href="#cb33-168" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>From the two Datasets, create two Dataloaders that use subsets of 64 images.</span>
<span id="cb33-169"><a href="#cb33-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-170"><a href="#cb33-170" aria-hidden="true" tabindex="-1"></a>Display the same figure as in Step 1, but with the images modified, explaining how the modifications were made. Submit the code used to modify the images and generate the figure.</span>
<span id="cb33-171"><a href="#cb33-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-174"><a href="#cb33-174" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb33-175"><a href="#cb33-175" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">MLUtils</span></span>
<span id="cb33-176"><a href="#cb33-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-177"><a href="#cb33-177" aria-hidden="true" tabindex="-1"></a><span class="pp">@views</span> <span class="kw">function</span> <span class="fu">get_labels</span>(source, ids)</span>
<span id="cb33-178"><a href="#cb33-178" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> <span class="fu">searchsortedfirst</span>.(<span class="fu">Ref</span>(source.GalaxyID), ids)</span>
<span id="cb33-179"><a href="#cb33-179" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> source[idx, <span class="fl">2</span><span class="op">:</span><span class="kw">end</span>]</span>
<span id="cb33-180"><a href="#cb33-180" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb33-181"><a href="#cb33-181" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-182"><a href="#cb33-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-185"><a href="#cb33-185" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb33-186"><a href="#cb33-186" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Define a Julia Dataset equivalent for training and testing</span></span>
<span id="cb33-187"><a href="#cb33-187" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> GalaxyDataset{I,L,F}</span>
<span id="cb33-188"><a href="#cb33-188" aria-hidden="true" tabindex="-1"></a>    ids<span class="op">::</span><span class="dt">I</span></span>
<span id="cb33-189"><a href="#cb33-189" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">::</span><span class="dt">L</span></span>
<span id="cb33-190"><a href="#cb33-190" aria-hidden="true" tabindex="-1"></a>    load<span class="op">::</span><span class="dt">F</span></span>
<span id="cb33-191"><a href="#cb33-191" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb33-192"><a href="#cb33-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-193"><a href="#cb33-193" aria-hidden="true" tabindex="-1"></a><span class="fu">transform_img</span>(img) <span class="op">=</span> <span class="fu">permutedims</span>(<span class="fu">channelview</span>(img), (<span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">1</span>))</span>
<span id="cb33-194"><a href="#cb33-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-195"><a href="#cb33-195" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="bu">Base</span>.<span class="fu">getindex</span>(dataset<span class="op">::</span><span class="dt">GalaxyDataset</span>, idx)</span>
<span id="cb33-196"><a href="#cb33-196" aria-hidden="true" tabindex="-1"></a>    ids <span class="op">=</span> dataset.ids[idx]</span>
<span id="cb33-197"><a href="#cb33-197" aria-hidden="true" tabindex="-1"></a>    img_arrays <span class="op">=</span> <span class="fu">convert</span>(<span class="dt">Array</span>{<span class="dt">Float32</span>,<span class="fl">4</span>}, <span class="fu">stack</span>(transform_img <span class="op">∘</span> dataset.load, ids; dims<span class="op">=</span><span class="fl">4</span>))</span>
<span id="cb33-198"><a href="#cb33-198" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> <span class="fu">convert</span>(<span class="dt">Matrix</span>{<span class="dt">Float32</span>}, <span class="fu">stack</span>(<span class="fu">get_labels</span>.(<span class="fu">Ref</span>(dataset.labels), ids); dims<span class="op">=</span><span class="fl">2</span>))</span>
<span id="cb33-199"><a href="#cb33-199" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> img_arrays, labels</span>
<span id="cb33-200"><a href="#cb33-200" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb33-201"><a href="#cb33-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-202"><a href="#cb33-202" aria-hidden="true" tabindex="-1"></a><span class="bu">Base</span>.<span class="fu">length</span>(dataset<span class="op">::</span><span class="dt">GalaxyDataset</span>) <span class="op">=</span> <span class="fu">length</span>(dataset.ids)</span>
<span id="cb33-203"><a href="#cb33-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-204"><a href="#cb33-204" aria-hidden="true" tabindex="-1"></a>train_ids, test_ids <span class="op">=</span> <span class="fu">splitobs</span>(galaxy_data.GalaxyID, at<span class="op">=</span><span class="fl">0.8</span>, shuffle<span class="op">=</span><span class="cn">true</span>)</span>
<span id="cb33-205"><a href="#cb33-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-206"><a href="#cb33-206" aria-hidden="true" tabindex="-1"></a><span class="co"># Create training and testing datasets</span></span>
<span id="cb33-207"><a href="#cb33-207" aria-hidden="true" tabindex="-1"></a>train_dataset <span class="op">=</span> <span class="fu">GalaxyDataset</span>(</span>
<span id="cb33-208"><a href="#cb33-208" aria-hidden="true" tabindex="-1"></a>    train_ids,</span>
<span id="cb33-209"><a href="#cb33-209" aria-hidden="true" tabindex="-1"></a>    galaxy_data,</span>
<span id="cb33-210"><a href="#cb33-210" aria-hidden="true" tabindex="-1"></a>    load_processed_img</span>
<span id="cb33-211"><a href="#cb33-211" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-212"><a href="#cb33-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-213"><a href="#cb33-213" aria-hidden="true" tabindex="-1"></a>test_dataset <span class="op">=</span> <span class="fu">GalaxyDataset</span>(</span>
<span id="cb33-214"><a href="#cb33-214" aria-hidden="true" tabindex="-1"></a>    test_ids,</span>
<span id="cb33-215"><a href="#cb33-215" aria-hidden="true" tabindex="-1"></a>    galaxy_data,</span>
<span id="cb33-216"><a href="#cb33-216" aria-hidden="true" tabindex="-1"></a>    load_processed_img</span>
<span id="cb33-217"><a href="#cb33-217" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-218"><a href="#cb33-218" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-219"><a href="#cb33-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-220"><a href="#cb33-220" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 6. Create DataLoaders with batch size</span></span>
<span id="cb33-221"><a href="#cb33-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-224"><a href="#cb33-224" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb33-225"><a href="#cb33-225" aria-hidden="true" tabindex="-1"></a>train_loader <span class="op">=</span> <span class="fu">DataLoader</span>(train_dataset, batchsize<span class="op">=</span><span class="fl">32</span>)</span>
<span id="cb33-226"><a href="#cb33-226" aria-hidden="true" tabindex="-1"></a>test_loader <span class="op">=</span> <span class="fu">DataLoader</span>(test_dataset, batchsize<span class="op">=</span><span class="fl">32</span>)</span>
<span id="cb33-227"><a href="#cb33-227" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-228"><a href="#cb33-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-231"><a href="#cb33-231" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb33-232"><a href="#cb33-232" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_images</span>(highest_prob_df, load_processed_img)</span>
<span id="cb33-233"><a href="#cb33-233" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-234"><a href="#cb33-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-235"><a href="#cb33-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-236"><a href="#cb33-236" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 3: Defining a CNN</span></span>
<span id="cb33-237"><a href="#cb33-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-238"><a href="#cb33-238" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; The data is now ready to be analyzed. Next, we need to define a CNN that will take the 64x64 images with 3 colors as input and give us a probability for the 37 classes as output. To start, define a CNN with the following elements (this is an adaptation of the CNN we used  with the FashionMNIST data):</span>  </span>
<span id="cb33-239"><a href="#cb33-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-240"><a href="#cb33-240" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Convolution layer with 6 output filters, a 5-pixel kernel, and a padding of 3.  </span>
<span id="cb33-241"><a href="#cb33-241" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Convolution layer with 16 output filters, a 5-pixel kernel, and a padding of 3.  </span>
<span id="cb33-242"><a href="#cb33-242" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Fully connected layer with 120 output neurons  </span>
<span id="cb33-243"><a href="#cb33-243" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Fully connected layer with 84 output neurons  </span>
<span id="cb33-244"><a href="#cb33-244" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>Final layer with logits for the 37 classes.  </span>
<span id="cb33-245"><a href="#cb33-245" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>We need to convert the 37 classes to probabilities. Which function seen in class allows us to convert logits to a value between 0 and 1? (Note: The probabilities are not mutually exclusive!)  </span>
<span id="cb33-246"><a href="#cb33-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-247"><a href="#cb33-247" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; After each convolution layer, use batch normalization, ReLU activation, and pooling with a kernel size of 2. </span></span>
<span id="cb33-248"><a href="#cb33-248" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Between the fully connected layers, use a ReLU activation function (except at the output of the final layer). Don’t forget to flatten the images between the last convolution layer and the first fully connected  layer.</span></span>
<span id="cb33-249"><a href="#cb33-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-250"><a href="#cb33-250" aria-hidden="true" tabindex="-1"></a>In the report, explain the general structure and function of the different layers. Submit the  code that defines this CNN.</span>
<span id="cb33-251"><a href="#cb33-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-252"><a href="#cb33-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-255"><a href="#cb33-255" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb33-256"><a href="#cb33-256" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">get_output_width</span>(width, kernel_size; stride<span class="op">=</span><span class="fl">1</span>, padding<span class="op">=</span><span class="fl">0</span>, dilation<span class="op">=</span><span class="fl">1</span>)</span>
<span id="cb33-257"><a href="#cb33-257" aria-hidden="true" tabindex="-1"></a>    <span class="fu">floor</span>(<span class="dt">Int</span>,</span>
<span id="cb33-258"><a href="#cb33-258" aria-hidden="true" tabindex="-1"></a>        (width <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> padding <span class="op">-</span> dilation <span class="op">*</span> (kernel_size <span class="op">-</span> <span class="fl">1</span>) <span class="op">-</span> <span class="fl">1</span>) <span class="op">/</span> stride <span class="op">+</span> <span class="fl">1</span></span>
<span id="cb33-259"><a href="#cb33-259" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-260"><a href="#cb33-260" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb33-261"><a href="#cb33-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-262"><a href="#cb33-262" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Chain</span>: @chain</span>
<span id="cb33-263"><a href="#cb33-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-264"><a href="#cb33-264" aria-hidden="true" tabindex="-1"></a><span class="pp">@chain</span> <span class="fl">64</span> <span class="cf">begin</span></span>
<span id="cb33-265"><a href="#cb33-265" aria-hidden="true" tabindex="-1"></a>    <span class="fu">get_output_width</span>(<span class="fl">5</span>; padding<span class="op">=</span><span class="fl">3</span>)</span>
<span id="cb33-266"><a href="#cb33-266" aria-hidden="true" tabindex="-1"></a>    <span class="fu">get_output_width</span>(<span class="fl">2</span>; stride<span class="op">=</span><span class="fl">2</span>)</span>
<span id="cb33-267"><a href="#cb33-267" aria-hidden="true" tabindex="-1"></a>    <span class="fu">get_output_width</span>(<span class="fl">5</span>; padding<span class="op">=</span><span class="fl">3</span>)</span>
<span id="cb33-268"><a href="#cb33-268" aria-hidden="true" tabindex="-1"></a>    <span class="fu">get_output_width</span>(<span class="fl">2</span>; stride<span class="op">=</span><span class="fl">2</span>)</span>
<span id="cb33-269"><a href="#cb33-269" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb33-270"><a href="#cb33-270" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-271"><a href="#cb33-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-274"><a href="#cb33-274" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb33-275"><a href="#cb33-275" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Random</span></span>
<span id="cb33-276"><a href="#cb33-276" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Lux</span></span>
<span id="cb33-277"><a href="#cb33-277" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Optimisers</span></span>
<span id="cb33-278"><a href="#cb33-278" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Zygote</span></span>
<span id="cb33-279"><a href="#cb33-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-280"><a href="#cb33-280" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> <span class="bu">Random</span>.<span class="fu">default_rng</span>()</span>
<span id="cb33-281"><a href="#cb33-281" aria-hidden="true" tabindex="-1"></a><span class="bu">Random</span>.<span class="fu">seed!</span>(rng, <span class="fl">42</span>)</span>
<span id="cb33-282"><a href="#cb33-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-283"><a href="#cb33-283" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">build_cnn_model</span>(; num_classes<span class="op">=</span><span class="fl">37</span>, pad<span class="op">=</span><span class="fl">3</span>)</span>
<span id="cb33-284"><a href="#cb33-284" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">Chain</span>(</span>
<span id="cb33-285"><a href="#cb33-285" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Chain</span>(</span>
<span id="cb33-286"><a href="#cb33-286" aria-hidden="true" tabindex="-1"></a>            <span class="fu">Conv</span>((<span class="fl">5</span>, <span class="fl">5</span>), <span class="fl">3</span> <span class="op">=&gt;</span> <span class="fl">6</span>; pad),</span>
<span id="cb33-287"><a href="#cb33-287" aria-hidden="true" tabindex="-1"></a>            <span class="fu">BatchNorm</span>(<span class="fl">6</span>, relu),</span>
<span id="cb33-288"><a href="#cb33-288" aria-hidden="true" tabindex="-1"></a>            <span class="fu">MaxPool</span>((<span class="fl">2</span>, <span class="fl">2</span>)),</span>
<span id="cb33-289"><a href="#cb33-289" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb33-290"><a href="#cb33-290" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Chain</span>(</span>
<span id="cb33-291"><a href="#cb33-291" aria-hidden="true" tabindex="-1"></a>            <span class="fu">Conv</span>((<span class="fl">5</span>, <span class="fl">5</span>), <span class="fl">6</span> <span class="op">=&gt;</span> <span class="fl">16</span>; pad),</span>
<span id="cb33-292"><a href="#cb33-292" aria-hidden="true" tabindex="-1"></a>            <span class="fu">BatchNorm</span>(<span class="fl">16</span>, relu),</span>
<span id="cb33-293"><a href="#cb33-293" aria-hidden="true" tabindex="-1"></a>            <span class="fu">MaxPool</span>((<span class="fl">2</span>, <span class="fl">2</span>)),</span>
<span id="cb33-294"><a href="#cb33-294" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb33-295"><a href="#cb33-295" aria-hidden="true" tabindex="-1"></a>        <span class="fu">FlattenLayer</span>(; N<span class="op">=</span><span class="fl">3</span>),</span>
<span id="cb33-296"><a href="#cb33-296" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Chain</span>(</span>
<span id="cb33-297"><a href="#cb33-297" aria-hidden="true" tabindex="-1"></a>            <span class="fu">Dense</span>(<span class="fl">4624</span> <span class="op">=&gt;</span> <span class="fl">120</span>, relu),</span>
<span id="cb33-298"><a href="#cb33-298" aria-hidden="true" tabindex="-1"></a>            <span class="fu">Dense</span>(<span class="fl">120</span> <span class="op">=&gt;</span> <span class="fl">84</span>, relu),</span>
<span id="cb33-299"><a href="#cb33-299" aria-hidden="true" tabindex="-1"></a>            <span class="fu">Dense</span>(<span class="fl">84</span> <span class="op">=&gt;</span> num_classes, sigmoid);</span>
<span id="cb33-300"><a href="#cb33-300" aria-hidden="true" tabindex="-1"></a>            name<span class="op">=</span><span class="st">"Fully connected layer"</span></span>
<span id="cb33-301"><a href="#cb33-301" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-302"><a href="#cb33-302" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-303"><a href="#cb33-303" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb33-304"><a href="#cb33-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-305"><a href="#cb33-305" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the model</span></span>
<span id="cb33-306"><a href="#cb33-306" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> <span class="fu">build_cnn_model</span>()</span>
<span id="cb33-307"><a href="#cb33-307" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-308"><a href="#cb33-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-309"><a href="#cb33-309" aria-hidden="true" tabindex="-1"></a>Create dummy input to test the model</span>
<span id="cb33-310"><a href="#cb33-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-313"><a href="#cb33-313" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb33-314"><a href="#cb33-314" aria-hidden="true" tabindex="-1"></a>ps, st <span class="op">=</span> Lux.<span class="fu">setup</span>(rng, model);</span>
<span id="cb33-315"><a href="#cb33-315" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="fu">rand</span>(rng, <span class="dt">Float32</span>, <span class="fl">64</span>, <span class="fl">64</span>, <span class="fl">3</span>, <span class="fl">2</span>)  <span class="co"># (height, width, channels, batch_size)</span></span>
<span id="cb33-316"><a href="#cb33-316" aria-hidden="true" tabindex="-1"></a><span class="fu">model</span>(x, ps, Lux.<span class="fu">testmode</span>(st))</span>
<span id="cb33-317"><a href="#cb33-317" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-318"><a href="#cb33-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-319"><a href="#cb33-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-320"><a href="#cb33-320" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 4: Training the network</span></span>
<span id="cb33-321"><a href="#cb33-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-322"><a href="#cb33-322" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Once the network is defined, it must be trained to recognize galaxies. Adapt the training and testing  loops we saw in class. Use the following hyperparameters, then train the model. </span></span>
<span id="cb33-323"><a href="#cb33-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-324"><a href="#cb33-324" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>MSE objective function</span>
<span id="cb33-325"><a href="#cb33-325" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Adam optimizer</span>
<span id="cb33-326"><a href="#cb33-326" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>6 epochs</span>
<span id="cb33-327"><a href="#cb33-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-328"><a href="#cb33-328" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Record the value of the objective function for each epoch, for the training and test data separately. Once  training is complete, display the evolution of the objective function for the training and test data.</span>  </span>
<span id="cb33-329"><a href="#cb33-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-330"><a href="#cb33-330" aria-hidden="true" tabindex="-1"></a>In the report, explain the training process and display the evolution of the objective function.  Submit the code used to train the network.</span>
<span id="cb33-331"><a href="#cb33-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-334"><a href="#cb33-334" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb33-335"><a href="#cb33-335" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Printf</span></span>
<span id="cb33-336"><a href="#cb33-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-337"><a href="#cb33-337" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">evaluate_model</span>(model, ps, st, dataloader, lossfn)</span>
<span id="cb33-338"><a href="#cb33-338" aria-hidden="true" tabindex="-1"></a>    total_loss <span class="op">=</span> <span class="fl">0.0f0</span></span>
<span id="cb33-339"><a href="#cb33-339" aria-hidden="true" tabindex="-1"></a>    total_batches <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb33-340"><a href="#cb33-340" aria-hidden="true" tabindex="-1"></a>    st <span class="op">=</span> Lux.<span class="fu">testmode</span>(st)</span>
<span id="cb33-341"><a href="#cb33-341" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@showprogress</span> <span class="st">"Testing..."</span> <span class="cf">for</span> (x, y) <span class="kw">in</span> dataloader</span>
<span id="cb33-342"><a href="#cb33-342" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Forward pass</span></span>
<span id="cb33-343"><a href="#cb33-343" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> <span class="fu">first</span>(<span class="fu">model</span>(x, ps, st))</span>
<span id="cb33-344"><a href="#cb33-344" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute loss</span></span>
<span id="cb33-345"><a href="#cb33-345" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> <span class="fu">lossfn</span>(y_pred, y)</span>
<span id="cb33-346"><a href="#cb33-346" aria-hidden="true" tabindex="-1"></a>        total_loss <span class="op">+=</span> loss</span>
<span id="cb33-347"><a href="#cb33-347" aria-hidden="true" tabindex="-1"></a>        total_batches <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb33-348"><a href="#cb33-348" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb33-349"><a href="#cb33-349" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> total_loss <span class="op">/</span> total_batches</span>
<span id="cb33-350"><a href="#cb33-350" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb33-351"><a href="#cb33-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-352"><a href="#cb33-352" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">init_evaluate_model</span>(model, ps, st, train_loader, test_loader, lossfn<span class="op">=</span><span class="fu">MSELoss</span>(); verbose<span class="op">=</span><span class="cn">true</span>)</span>
<span id="cb33-353"><a href="#cb33-353" aria-hidden="true" tabindex="-1"></a>    train_loss <span class="op">=</span> <span class="fu">evaluate_model</span>(model, ps, st, train_loader, lossfn)</span>
<span id="cb33-354"><a href="#cb33-354" aria-hidden="true" tabindex="-1"></a>    test_loss <span class="op">=</span> <span class="fu">evaluate_model</span>(model, ps, st, test_loader, lossfn)</span>
<span id="cb33-355"><a href="#cb33-355" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> verbose</span>
<span id="cb33-356"><a href="#cb33-356" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@printf</span> <span class="st">"Initial: Train Loss %4.5f, Test Loss %4.5f</span><span class="sc">\n</span><span class="st">"</span> train_loss test_loss</span>
<span id="cb33-357"><a href="#cb33-357" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb33-358"><a href="#cb33-358" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> train_loss, test_loss</span>
<span id="cb33-359"><a href="#cb33-359" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb33-360"><a href="#cb33-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-361"><a href="#cb33-361" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-362"><a href="#cb33-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-365"><a href="#cb33-365" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb33-366"><a href="#cb33-366" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">JLD2</span></span>
<span id="cb33-367"><a href="#cb33-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-368"><a href="#cb33-368" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">train_model!</span>(model, ps, st, train_loader, test_loader; op<span class="op">=</span><span class="fu">Adam</span>(<span class="fl">0.003f0</span>), epochs<span class="op">=</span><span class="fl">6</span>)</span>
<span id="cb33-369"><a href="#cb33-369" aria-hidden="true" tabindex="-1"></a>    train_state <span class="op">=</span> Training.<span class="fu">TrainState</span>(model, ps, st, op)</span>
<span id="cb33-370"><a href="#cb33-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-371"><a href="#cb33-371" aria-hidden="true" tabindex="-1"></a>    ad <span class="op">=</span> <span class="fu">AutoZygote</span>()</span>
<span id="cb33-372"><a href="#cb33-372" aria-hidden="true" tabindex="-1"></a>    lossfn <span class="op">=</span> <span class="fu">MSELoss</span>()</span>
<span id="cb33-373"><a href="#cb33-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-374"><a href="#cb33-374" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize arrays to store losses</span></span>
<span id="cb33-375"><a href="#cb33-375" aria-hidden="true" tabindex="-1"></a>    train_losses <span class="op">=</span> <span class="dt">Float32</span>[]</span>
<span id="cb33-376"><a href="#cb33-376" aria-hidden="true" tabindex="-1"></a>    test_losses <span class="op">=</span> <span class="dt">Float32</span>[]</span>
<span id="cb33-377"><a href="#cb33-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-378"><a href="#cb33-378" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>epochs</span>
<span id="cb33-379"><a href="#cb33-379" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Training phase</span></span>
<span id="cb33-380"><a href="#cb33-380" aria-hidden="true" tabindex="-1"></a>        total_loss <span class="op">=</span> <span class="fl">0.0f0</span></span>
<span id="cb33-381"><a href="#cb33-381" aria-hidden="true" tabindex="-1"></a>        total_batches <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb33-382"><a href="#cb33-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-383"><a href="#cb33-383" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@showprogress</span> <span class="st">"Training..."</span> <span class="cf">for</span> data <span class="kw">in</span> train_loader</span>
<span id="cb33-384"><a href="#cb33-384" aria-hidden="true" tabindex="-1"></a>            _, loss, _, train_state <span class="op">=</span> Training.<span class="fu">single_train_step!</span>(</span>
<span id="cb33-385"><a href="#cb33-385" aria-hidden="true" tabindex="-1"></a>                ad, lossfn,</span>
<span id="cb33-386"><a href="#cb33-386" aria-hidden="true" tabindex="-1"></a>                data, train_state</span>
<span id="cb33-387"><a href="#cb33-387" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb33-388"><a href="#cb33-388" aria-hidden="true" tabindex="-1"></a>            total_loss <span class="op">+=</span> loss</span>
<span id="cb33-389"><a href="#cb33-389" aria-hidden="true" tabindex="-1"></a>            total_batches <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb33-390"><a href="#cb33-390" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb33-391"><a href="#cb33-391" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate average training loss for this epoch</span></span>
<span id="cb33-392"><a href="#cb33-392" aria-hidden="true" tabindex="-1"></a>        train_loss <span class="op">=</span> total_loss <span class="op">/</span> total_batches</span>
<span id="cb33-393"><a href="#cb33-393" aria-hidden="true" tabindex="-1"></a>        <span class="fu">push!</span>(train_losses, train_loss)</span>
<span id="cb33-394"><a href="#cb33-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-395"><a href="#cb33-395" aria-hidden="true" tabindex="-1"></a>        test_loss <span class="op">=</span> <span class="fu">evaluate_model</span>(model, train_state.parameters, train_state.states, test_loader, lossfn)</span>
<span id="cb33-396"><a href="#cb33-396" aria-hidden="true" tabindex="-1"></a>        <span class="fu">push!</span>(test_losses, test_loss)</span>
<span id="cb33-397"><a href="#cb33-397" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@printf</span> <span class="st">"Epoch [%3d]: Train Loss %4.5f, Test Loss %4.5f</span><span class="sc">\n</span><span class="st">"</span> epoch train_loss test_loss</span>
<span id="cb33-398"><a href="#cb33-398" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb33-399"><a href="#cb33-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-400"><a href="#cb33-400" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> train_state, train_losses, test_losses</span>
<span id="cb33-401"><a href="#cb33-401" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb33-402"><a href="#cb33-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-403"><a href="#cb33-403" aria-hidden="true" tabindex="-1"></a><span class="co"># load file if it exists</span></span>
<span id="cb33-404"><a href="#cb33-404" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="fl">6</span></span>
<span id="cb33-405"><a href="#cb33-405" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="fu">isfile</span>(<span class="st">"trained_model.jld2"</span>)</span>
<span id="cb33-406"><a href="#cb33-406" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@load</span> <span class="st">"trained_model.jld2"</span> ps_trained st_trained train_losses test_losses</span>
<span id="cb33-407"><a href="#cb33-407" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb33-408"><a href="#cb33-408" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluate initial losses before training</span></span>
<span id="cb33-409"><a href="#cb33-409" aria-hidden="true" tabindex="-1"></a>    initial_train_loss, initial_test_loss <span class="op">=</span> <span class="fu">init_evaluate_model</span>(model, ps, st, train_loader, test_loader; verbose<span class="op">=</span><span class="cn">true</span>)</span>
<span id="cb33-410"><a href="#cb33-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-411"><a href="#cb33-411" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train the model and record both training and testing losses</span></span>
<span id="cb33-412"><a href="#cb33-412" aria-hidden="true" tabindex="-1"></a>    train_state, train_losses, test_losses <span class="op">=</span> <span class="fu">train_model!</span>(model, ps, st, train_loader, test_loader; epochs)</span>
<span id="cb33-413"><a href="#cb33-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-414"><a href="#cb33-414" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Append training losses to the initial losses</span></span>
<span id="cb33-415"><a href="#cb33-415" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prepend!</span>(train_losses, initial_train_loss)</span>
<span id="cb33-416"><a href="#cb33-416" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prepend!</span>(test_losses, initial_test_loss)</span>
<span id="cb33-417"><a href="#cb33-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-418"><a href="#cb33-418" aria-hidden="true" tabindex="-1"></a>    ps_trained, st_trained <span class="op">=</span> train_state.parameters, train_state.states</span>
<span id="cb33-419"><a href="#cb33-419" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@save</span> <span class="st">"trained_model.jld2"</span> ps_trained st_trained train_losses test_losses</span>
<span id="cb33-420"><a href="#cb33-420" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb33-421"><a href="#cb33-421" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-422"><a href="#cb33-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-425"><a href="#cb33-425" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb33-426"><a href="#cb33-426" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the evolution of the training and testing loss</span></span>
<span id="cb33-427"><a href="#cb33-427" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> <span class="fu">Figure</span>()</span>
<span id="cb33-428"><a href="#cb33-428" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">1</span>, <span class="fl">1</span>],</span>
<span id="cb33-429"><a href="#cb33-429" aria-hidden="true" tabindex="-1"></a>    xlabel<span class="op">=</span><span class="st">"Epoch"</span>,</span>
<span id="cb33-430"><a href="#cb33-430" aria-hidden="true" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">"Mean Squared Error"</span>,</span>
<span id="cb33-431"><a href="#cb33-431" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Training and Testing Loss Evolution"</span>,</span>
<span id="cb33-432"><a href="#cb33-432" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-433"><a href="#cb33-433" aria-hidden="true" tabindex="-1"></a><span class="fu">scatterlines!</span>(<span class="fl">0</span><span class="op">:</span>epochs, train_losses, linewidth<span class="op">=</span><span class="fl">3</span>, color<span class="op">=:</span>blue, label<span class="op">=</span><span class="st">"Training Loss"</span>)</span>
<span id="cb33-434"><a href="#cb33-434" aria-hidden="true" tabindex="-1"></a><span class="fu">scatterlines!</span>(<span class="fl">0</span><span class="op">:</span>epochs, test_losses, linewidth<span class="op">=</span><span class="fl">3</span>, color<span class="op">=:</span>red, label<span class="op">=</span><span class="st">"Testing Loss"</span>)</span>
<span id="cb33-435"><a href="#cb33-435" aria-hidden="true" tabindex="-1"></a><span class="fu">axislegend</span>(ax, position<span class="op">=:</span>rt)</span>
<span id="cb33-436"><a href="#cb33-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-437"><a href="#cb33-437" aria-hidden="true" tabindex="-1"></a>fig</span>
<span id="cb33-438"><a href="#cb33-438" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-439"><a href="#cb33-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-440"><a href="#cb33-440" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 5: Model evaluation</span></span>
<span id="cb33-441"><a href="#cb33-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-442"><a href="#cb33-442" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; With the trained model, what is the RMSE value for the test data? For reference, a simple solution  that uses the average color of the 100 central pixels (10x10) gives an RMSE of 0.16194. How does your neural network compare to this method?</span></span>
<span id="cb33-443"><a href="#cb33-443" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; The dataset we are studying was used in a Kaggle competition several years ago:  https://www.kaggle.com/c/galaxy-zoo-the-galaxy-challenge. Several people have attempted to find a  solution that gives the smallest possible RMSE. The solutions are ranked in the Leaderboard tab. How does the solution obtained in Step 4 rank?</span></span>
<span id="cb33-444"><a href="#cb33-444" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; In the report, report the RMSE and discuss the comparison with a simplistic method (central pixels). Submit the code used to calculate the RMSE.</span></span>
<span id="cb33-445"><a href="#cb33-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-448"><a href="#cb33-448" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb33-449"><a href="#cb33-449" aria-hidden="true" tabindex="-1"></a>cnn_rmse <span class="op">=</span> <span class="fu">sqrt</span>(test_losses[<span class="kw">end</span>])</span>
<span id="cb33-450"><a href="#cb33-450" aria-hidden="true" tabindex="-1"></a>simple_rmse_ref <span class="op">=</span> <span class="fl">0.16194</span></span>
<span id="cb33-451"><a href="#cb33-451" aria-hidden="true" tabindex="-1"></a>improvement <span class="op">=</span> <span class="fu">round</span>(((simple_rmse_ref <span class="op">-</span> cnn_rmse) <span class="op">/</span> simple_rmse_ref <span class="op">*</span> <span class="fl">100</span>), digits<span class="op">=</span><span class="fl">2</span>)</span>
<span id="cb33-452"><a href="#cb33-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-453"><a href="#cb33-453" aria-hidden="true" tabindex="-1"></a><span class="pp">@info</span> <span class="st">"CNN RMSE on train data: "</span> <span class="fu">sqrt</span>(train_losses[<span class="kw">end</span>])</span>
<span id="cb33-454"><a href="#cb33-454" aria-hidden="true" tabindex="-1"></a><span class="pp">@info</span> <span class="st">"CNN RMSE on test data: "</span> <span class="fu">sqrt</span>(test_losses[<span class="kw">end</span>])</span>
<span id="cb33-455"><a href="#cb33-455" aria-hidden="true" tabindex="-1"></a><span class="pp">@info</span> <span class="st">"Improvement: </span><span class="sc">$</span>(improvement)<span class="st"> %"</span></span>
<span id="cb33-456"><a href="#cb33-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-457"><a href="#cb33-457" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> cnn_rmse <span class="op">&lt;</span> simple_rmse_ref</span>
<span id="cb33-458"><a href="#cb33-458" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Our CNN model outperforms the simple central pixels method!"</span>)</span>
<span id="cb33-459"><a href="#cb33-459" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"This demonstrates that the CNN can learn complex patterns across the entire image rather than just using the central region."</span>)</span>
<span id="cb33-460"><a href="#cb33-460" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb33-461"><a href="#cb33-461" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Our CNN model doesn't outperform the simple method yet."</span>)</span>
<span id="cb33-462"><a href="#cb33-462" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"This could be due to several factors:"</span>)</span>
<span id="cb33-463"><a href="#cb33-463" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"1. Limited training epochs"</span>)</span>
<span id="cb33-464"><a href="#cb33-464" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"2. Model architecture might need optimization"</span>)</span>
<span id="cb33-465"><a href="#cb33-465" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"3. Learning rate or other hyperparameters might need tuning"</span>)</span>
<span id="cb33-466"><a href="#cb33-466" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb33-467"><a href="#cb33-467" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-468"><a href="#cb33-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-469"><a href="#cb33-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-470"><a href="#cb33-470" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 6: Model modification</span></span>
<span id="cb33-471"><a href="#cb33-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-472"><a href="#cb33-472" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; In class, we saw different ways to improve model performance (regularization, dropout, data augmentation, adding layers, changing the model configuration or training process). Modify the model and  evaluate the effect of the changes on training. You can also completely redefine the model, either using a known architecture (e.g., ResNet) or an original architecture. How does the performance compare to  that of Steps 3-4-5? Can you explain why the changes had this effect?</span></span>
<span id="cb33-473"><a href="#cb33-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-474"><a href="#cb33-474" aria-hidden="true" tabindex="-1"></a>Grading scale:</span>
<span id="cb33-475"><a href="#cb33-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-476"><a href="#cb33-476" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Any simple modification to the model ensures at least 6/10</span>
<span id="cb33-477"><a href="#cb33-477" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Additional modifications are worth 1 point each, up to a total of 10/10</span>
<span id="cb33-478"><a href="#cb33-478" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Rewriting a completely different architecture with a similar or larger number of parameters and at  least two hidden layers automatically earns full points (10/10)</span>
<span id="cb33-479"><a href="#cb33-479" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Model performance does not earn any additional points. The goal is really to get you to explore  possible modifications!  In the report, indicate what modifications you made, the effect they had, and why they had that  effect. Also include a comparison of the RMSE with the previous steps. Submit the modified  code for this section.</span>
<span id="cb33-480"><a href="#cb33-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-481"><a href="#cb33-481" aria-hidden="true" tabindex="-1"></a><span class="fu">### Using ResNet for Galaxy Classification</span></span>
<span id="cb33-482"><a href="#cb33-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-485"><a href="#cb33-485" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb33-486"><a href="#cb33-486" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Boltz</span>, <span class="bu">Metalhead</span>, <span class="bu">Lux</span></span>
<span id="cb33-487"><a href="#cb33-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-488"><a href="#cb33-488" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to create a modified ResNet for our galaxy classification task</span></span>
<span id="cb33-489"><a href="#cb33-489" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">build_resnet_model</span>(; num_classes<span class="op">=</span><span class="fl">37</span>)</span>
<span id="cb33-490"><a href="#cb33-490" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the base ResNet-18 model</span></span>
<span id="cb33-491"><a href="#cb33-491" aria-hidden="true" tabindex="-1"></a>    resnet <span class="op">=</span> Vision.<span class="fu">ResNet</span>(<span class="fl">18</span>)</span>
<span id="cb33-492"><a href="#cb33-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-493"><a href="#cb33-493" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract all layers except the final classification layer</span></span>
<span id="cb33-494"><a href="#cb33-494" aria-hidden="true" tabindex="-1"></a>    base_layers <span class="op">=</span> resnet.layer.layer_1</span>
<span id="cb33-495"><a href="#cb33-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-496"><a href="#cb33-496" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a new final layer for our 37-class multi-label classification</span></span>
<span id="cb33-497"><a href="#cb33-497" aria-hidden="true" tabindex="-1"></a>    final_layer <span class="op">=</span> <span class="fu">Chain</span>(</span>
<span id="cb33-498"><a href="#cb33-498" aria-hidden="true" tabindex="-1"></a>        <span class="fu">AdaptiveMeanPool</span>((<span class="fl">1</span>, <span class="fl">1</span>)),</span>
<span id="cb33-499"><a href="#cb33-499" aria-hidden="true" tabindex="-1"></a>        <span class="fu">FlattenLayer</span>(; N<span class="op">=</span><span class="fl">3</span>),</span>
<span id="cb33-500"><a href="#cb33-500" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Dense</span>(<span class="fl">512</span> <span class="op">=&gt;</span> num_classes, sigmoid)</span>
<span id="cb33-501"><a href="#cb33-501" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-502"><a href="#cb33-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-503"><a href="#cb33-503" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine the base layers with our new classification head</span></span>
<span id="cb33-504"><a href="#cb33-504" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">Chain</span>(base_layers, final_layer)</span>
<span id="cb33-505"><a href="#cb33-505" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb33-506"><a href="#cb33-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-507"><a href="#cb33-507" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the ResNet model</span></span>
<span id="cb33-508"><a href="#cb33-508" aria-hidden="true" tabindex="-1"></a>resnet_model <span class="op">=</span> <span class="fu">build_resnet_model</span>()</span>
<span id="cb33-509"><a href="#cb33-509" aria-hidden="true" tabindex="-1"></a>resnet_ps, resnet_st <span class="op">=</span> Lux.<span class="fu">setup</span>(rng, resnet_model)</span>
<span id="cb33-510"><a href="#cb33-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-511"><a href="#cb33-511" aria-hidden="true" tabindex="-1"></a><span class="co"># Show model structure</span></span>
<span id="cb33-512"><a href="#cb33-512" aria-hidden="true" tabindex="-1"></a>resnet_model</span>
<span id="cb33-513"><a href="#cb33-513" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-514"><a href="#cb33-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-515"><a href="#cb33-515" aria-hidden="true" tabindex="-1"></a><span class="fu">### Testing the ResNet Model with Sample Data</span></span>
<span id="cb33-516"><a href="#cb33-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-519"><a href="#cb33-519" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb33-520"><a href="#cb33-520" aria-hidden="true" tabindex="-1"></a><span class="co"># Create dummy input to test the model</span></span>
<span id="cb33-521"><a href="#cb33-521" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> <span class="fu">rand</span>(rng, <span class="dt">Float32</span>, <span class="fl">64</span>, <span class="fl">64</span>, <span class="fl">3</span>, <span class="fl">2</span>)  <span class="co"># (height, width, channels, batch_size)</span></span>
<span id="cb33-522"><a href="#cb33-522" aria-hidden="true" tabindex="-1"></a><span class="fu">resnet_model</span>(x_test, resnet_ps, Lux.<span class="fu">testmode</span>(resnet_st))</span>
<span id="cb33-523"><a href="#cb33-523" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-524"><a href="#cb33-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-525"><a href="#cb33-525" aria-hidden="true" tabindex="-1"></a><span class="fu">### Training the ResNet Model</span></span>
<span id="cb33-526"><a href="#cb33-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-529"><a href="#cb33-529" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb33-530"><a href="#cb33-530" aria-hidden="true" tabindex="-1"></a>resnet_epochs <span class="op">=</span> <span class="fl">3</span></span>
<span id="cb33-531"><a href="#cb33-531" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate initial performance</span></span>
<span id="cb33-532"><a href="#cb33-532" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="fu">isfile</span>(<span class="st">"resnet_trained_model.jld2"</span>)</span>
<span id="cb33-533"><a href="#cb33-533" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@load</span> <span class="st">"resnet_trained_model.jld2"</span> resnet_ps_trained resnet_st_trained resnet_train_losses resnet_test_losses</span>
<span id="cb33-534"><a href="#cb33-534" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb33-535"><a href="#cb33-535" aria-hidden="true" tabindex="-1"></a>    initial_train_loss, initial_test_loss <span class="op">=</span> <span class="fu">init_evaluate_model</span>(resnet_model, resnet_ps, resnet_st, train_loader, test_loader)</span>
<span id="cb33-536"><a href="#cb33-536" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@printf</span> <span class="st">"Initial ResNet: Train Loss %4.5f, Test Loss %4.5f</span><span class="sc">\n</span><span class="st">"</span> initial_train_loss initial_test_loss</span>
<span id="cb33-537"><a href="#cb33-537" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train the ResNet model</span></span>
<span id="cb33-538"><a href="#cb33-538" aria-hidden="true" tabindex="-1"></a>    resnet_train_state, resnet_train_losses, resnet_test_losses <span class="op">=</span> <span class="fu">train_model!</span>(resnet_model, resnet_ps, resnet_st, train_loader, test_loader; op<span class="op">=</span><span class="fu">Adam</span>(<span class="fl">0.0005f0</span>), epochs<span class="op">=</span>resnet_epochs)</span>
<span id="cb33-539"><a href="#cb33-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-540"><a href="#cb33-540" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepend initial losses</span></span>
<span id="cb33-541"><a href="#cb33-541" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prepend!</span>(resnet_train_losses, initial_train_loss)</span>
<span id="cb33-542"><a href="#cb33-542" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prepend!</span>(resnet_test_losses, initial_test_loss)</span>
<span id="cb33-543"><a href="#cb33-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-544"><a href="#cb33-544" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the trained model</span></span>
<span id="cb33-545"><a href="#cb33-545" aria-hidden="true" tabindex="-1"></a>    resnet_ps_trained, resnet_st_trained <span class="op">=</span> resnet_train_state.parameters, resnet_train_state.states</span>
<span id="cb33-546"><a href="#cb33-546" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@save</span> <span class="st">"resnet_trained_model.jld2"</span> resnet_ps_trained resnet_st_trained resnet_train_losses resnet_test_losses</span>
<span id="cb33-547"><a href="#cb33-547" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb33-548"><a href="#cb33-548" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-549"><a href="#cb33-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-550"><a href="#cb33-550" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualizing ResNet Training Results</span></span>
<span id="cb33-551"><a href="#cb33-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-554"><a href="#cb33-554" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb33-555"><a href="#cb33-555" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the evolution of the training and testing loss for ResNet</span></span>
<span id="cb33-556"><a href="#cb33-556" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> <span class="fu">Figure</span>()</span>
<span id="cb33-557"><a href="#cb33-557" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">1</span>, <span class="fl">1</span>],</span>
<span id="cb33-558"><a href="#cb33-558" aria-hidden="true" tabindex="-1"></a>    xlabel<span class="op">=</span><span class="st">"Epoch"</span>,</span>
<span id="cb33-559"><a href="#cb33-559" aria-hidden="true" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">"Mean Squared Error"</span>,</span>
<span id="cb33-560"><a href="#cb33-560" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"ResNet Training and Testing Loss Evolution"</span>,</span>
<span id="cb33-561"><a href="#cb33-561" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-562"><a href="#cb33-562" aria-hidden="true" tabindex="-1"></a><span class="fu">scatterlines!</span>(<span class="fl">0</span><span class="op">:</span>resnet_epochs, resnet_train_losses, linewidth<span class="op">=</span><span class="fl">3</span>, color<span class="op">=:</span>blue, label<span class="op">=</span><span class="st">"ResNet Training Loss"</span>)</span>
<span id="cb33-563"><a href="#cb33-563" aria-hidden="true" tabindex="-1"></a><span class="fu">scatterlines!</span>(<span class="fl">0</span><span class="op">:</span>resnet_epochs, resnet_test_losses, linewidth<span class="op">=</span><span class="fl">3</span>, color<span class="op">=:</span>red, label<span class="op">=</span><span class="st">"ResNet Testing Loss"</span>)</span>
<span id="cb33-564"><a href="#cb33-564" aria-hidden="true" tabindex="-1"></a><span class="fu">axislegend</span>(ax, position<span class="op">=:</span>rt)</span>
<span id="cb33-565"><a href="#cb33-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-566"><a href="#cb33-566" aria-hidden="true" tabindex="-1"></a>fig</span>
<span id="cb33-567"><a href="#cb33-567" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-568"><a href="#cb33-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-569"><a href="#cb33-569" aria-hidden="true" tabindex="-1"></a><span class="fu">### Comparing ResNet with Original CNN</span></span>
<span id="cb33-570"><a href="#cb33-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-573"><a href="#cb33-573" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb33-574"><a href="#cb33-574" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare RMSE of ResNet with the original CNN</span></span>
<span id="cb33-575"><a href="#cb33-575" aria-hidden="true" tabindex="-1"></a>resnet_rmse <span class="op">=</span> <span class="fu">sqrt</span>(resnet_test_losses[<span class="kw">end</span>])</span>
<span id="cb33-576"><a href="#cb33-576" aria-hidden="true" tabindex="-1"></a>cnn_rmse <span class="op">=</span> <span class="fu">sqrt</span>(test_losses[<span class="kw">end</span>])</span>
<span id="cb33-577"><a href="#cb33-577" aria-hidden="true" tabindex="-1"></a>simple_rmse_ref <span class="op">=</span> <span class="fl">0.16194</span></span>
<span id="cb33-578"><a href="#cb33-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-579"><a href="#cb33-579" aria-hidden="true" tabindex="-1"></a><span class="pp">@info</span> <span class="st">"Original CNN RMSE: "</span> cnn_rmse</span>
<span id="cb33-580"><a href="#cb33-580" aria-hidden="true" tabindex="-1"></a><span class="pp">@info</span> <span class="st">"ResNet RMSE: "</span> resnet_rmse</span>
<span id="cb33-581"><a href="#cb33-581" aria-hidden="true" tabindex="-1"></a><span class="pp">@info</span> <span class="st">"Reference simple method RMSE: "</span> simple_rmse_ref</span>
<span id="cb33-582"><a href="#cb33-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-583"><a href="#cb33-583" aria-hidden="true" tabindex="-1"></a>resnet_improvement <span class="op">=</span> <span class="fu">round</span>(((cnn_rmse <span class="op">-</span> resnet_rmse) <span class="op">/</span> cnn_rmse <span class="op">*</span> <span class="fl">100</span>), digits<span class="op">=</span><span class="fl">2</span>)</span>
<span id="cb33-584"><a href="#cb33-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-585"><a href="#cb33-585" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> resnet_rmse <span class="op">&lt;</span> cnn_rmse</span>
<span id="cb33-586"><a href="#cb33-586" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">ResNet outperforms our original CNN by </span><span class="sc">$</span>(resnet_improvement)<span class="st">%!"</span>)</span>
<span id="cb33-587"><a href="#cb33-587" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"The skip connections in ResNet help with gradient flow during training, </span></span>
<span id="cb33-588"><a href="#cb33-588" aria-hidden="true" tabindex="-1"></a>        allowing the network to learn more complex features.<span class="st">"</span></span>
<span id="cb33-589"><a href="#cb33-589" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-590"><a href="#cb33-590" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb33-591"><a href="#cb33-591" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">ResNet doesn't outperform our original CNN."</span>)</span>
<span id="cb33-592"><a href="#cb33-592" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"This could be due to:"</span>)</span>
<span id="cb33-593"><a href="#cb33-593" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"1. Limited training time (ResNet is much larger and needs more epochs)"</span>)</span>
<span id="cb33-594"><a href="#cb33-594" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"2. Potential overfitting due to the larger model size"</span>)</span>
<span id="cb33-595"><a href="#cb33-595" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"3. The original CNN might be better suited for this specific dataset size"</span>)</span>
<span id="cb33-596"><a href="#cb33-596" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb33-597"><a href="#cb33-597" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-598"><a href="#cb33-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-599"><a href="#cb33-599" aria-hidden="true" tabindex="-1"></a><span class="fu">## References</span></span>
<span id="cb33-600"><a href="#cb33-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-601"><a href="#cb33-601" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Galaxy Zoo - The Galaxy Challenge | Kaggle</span><span class="co">](https://www.kaggle.com/competitions/galaxy-zoo-the-galaxy-challenge/overview)</span></span>
<span id="cb33-602"><a href="#cb33-602" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">My solution for the Galaxy Zoo challenge – Sander Dieleman</span><span class="co">](https://sander.ai/2014/04/05/galaxy-zoo.html)</span></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="../../../../../about.html">
<p>About</p>
</a>
  </li>  
</ul>
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/Beforerr/beforerr/blob/main/docs/courses/epss298_DataAnalysis/projects/proj2/index.qmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li><li><a href="https://github.com/Beforerr/beforerr/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>